<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Floresta M√≠stica - Aden RPG</title>
    <script src="maintenance.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<style>
.goog-te-banner-frame.skiptranslate,.skiptranslate{display:none!important;visibility:hidden!important;height:0!important;}
body{top:0!important;margin-top:0!important;position:static!important;}
.goog-te-balloon-frame,.goog-te-gadget{display:none!important;height:0!important;overflow:hidden!important;}
font>font{background-color:transparent!important;box-shadow:none!important;position:static!important;}
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
body,p,span,div,button,label{font-family:'Cinzel',serif;}
h1,h2,h3{font-family:'Cinzel',serif;color:#e0dccc;text-shadow:2px 2px 4px #000;}
html,body{height:100%;margin:0;padding:0;box-sizing:border-box;}
body{display:flex;flex-direction:column;align-items:center;background:#121212;min-height:100vh;overflow-x:hidden;}

#playerTopBar{position:fixed;top:0;left:0;width:100%;height:50px;background:#1a1a1a;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:0 12px;box-shadow:0 2px 8px rgba(0,0,0,.7);z-index:1000;box-sizing:border-box;}
.top-bar-link{color:#fff;text-decoration:none;display:flex;align-items:center;}
#pageTitle{color:#ffb3b3;font-size:1.2em;font-weight:bold;text-shadow:1px 1px 2px #000;}

#mapContainer{position:fixed;top:0;left:0;width:100vw;height:100vh;overflow:hidden;z-index:1;background:#0d1a0d;}
#map{background-image:url('https://aden-rpg.pages.dev/assets/floresta_mistica.webp');background-size:contain;background-repeat:no-repeat;background-position:top left;width:1500px;height:1500px;position:absolute;cursor:grab;transform-origin:top left;transform:scale(1.1);user-select:none;}

.hunt-spot{position:absolute;border:2px dashed transparent;
/*border:2px dashed #0f0;*/
border-radius:8px;cursor:default;overflow:visible;z-index:5;}
.hunt-spot:hover,.hunt-spot:focus,.hunt-spot:active{border-color:transparent;outline:none;}
.spot-label{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.65);font-size:.6em;font-weight:bold;text-shadow:1px 1px 3px #000;white-space:nowrap;pointer-events:none;}
.hunt-spot.active-spot{cursor:default!important;}

.mob-wrapper{position:absolute;display:flex;flex-direction:column;align-items:center;gap:2px;z-index:6;pointer-events:none;}
.mob-name{font-size:.55em;font-weight:bold;text-shadow:1px 1px 2px #000;white-space:nowrap;}
.mob-avatar{width:60px;height:60px;border-radius:50%;border:3px solid #c00;object-fit:cover;background:#222;}

.player-avatar-wrapper{position:absolute;display:flex;flex-direction:column;align-items:center;gap:2px;z-index:10;pointer-events:none;}
.player-shield-icon{width:30px;height:30px;object-fit:contain;}
.player-name-label{font-size:.55em;font-weight:bold;color:#ff8;text-shadow:1px 1px 2px #000;white-space:nowrap;}
.player-spot-avatar{width:60px;height:60px;border-radius:50%;border:3px solid #fc0;object-fit:cover;background:#222;}

.other-player-wrapper{position:absolute;display:flex;flex-direction:column;align-items:center;gap:2px;z-index:9;cursor:pointer;}
.other-player-shield{width:30px;height:30px;object-fit:contain;}
.other-player-name{font-size:.55em;font-weight:bold;color:#8cf;text-shadow:1px 1px 2px #000;white-space:nowrap;}
.other-player-avatar{width:60px;height:60px;border-radius:50%;border:3px solid #48f;object-fit:cover;background:#222;transition:filter .3s;}
.other-player-avatar.eliminated{filter:grayscale(100%) brightness(.6);}
.other-eliminated-label{font-size:.55em;color:#f44;font-weight:bold;text-shadow:1px 1px 2px #000;}

#contentOverlay{position:fixed;top:50px;left:0;width:100%;display:flex;flex-direction:column;align-items:center;z-index:10;pointer-events:none;}
#huntingHud{display:none;flex-direction:column;align-items:center;gap:5px;background:rgba(8,18,8,.9);border:1px solid #3a6c3a;border-radius:0 0 12px 12px;padding:8px 24px 12px;pointer-events:auto;min-width:240px;box-shadow:0 4px 16px rgba(0,0,0,.6);}
#huntTimer {
  font-size:1.9em;
  font-weight:bold;
  text-shadow: none;
  background: linear-gradient(to bottom, lightblue 0%, white 50%, blue 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent; 0 12px #4f4,1px 1px 2px #000;
  letter-spacing:3px;
  
}
#huntStatus{font-size:.7em;color:#b8d4b8;}
#shieldHudRow{display:flex;align-items:center;gap:8px;font-size:.7em;color:#acf;}
#shieldHudRow img{width:22px;height:22px;}
#hudBtnRow{display:flex;gap:8px;margin-top:2px;}
.hud-btn{background:rgba(255,255,255,.06);border:1px solid #455;color:#aca;padding:5px 14px;border-radius:5px;cursor:pointer;font-family:'Cinzel',serif;font-size:.65em;font-weight:bold;}
.hud-btn:hover{background:rgba(255,255,255,.14);color:#efe;}
.hud-btn:disabled{opacity:.4;cursor:not-allowed;}

#loadingOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:3000;justify-content:center;align-items:center;}
.loading-spinner{border:4px solid #2a3a2a;border-top:4px solid #8f8;border-radius:50%;width:50px;height:50px;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

.modal-container{display:none;position:fixed;z-index:9000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.88);justify-content:center;align-items:center;}
.modal-content{background:#1b271b;padding:22px;border:2px solid #4a8c4a;border-radius:10px;width:92%;max-width:460px;position:relative;max-height:90vh;box-sizing:border-box;text-align:center;overflow-y:auto;}
.modal-content h2,.modal-content h3{margin-top:0;color:#afa;text-shadow:0 0 8px #4f4,1px 1px 2px #000;font-size:1.05em;}
.modal-content p{color:#cdc;font-size:.85em;line-height:1.6;}
.modal-close{color:#787;position:absolute;top:8px;right:14px;font-size:26px;font-weight:bold;cursor:pointer;line-height:1;}
.modal-close:hover{color:#afa;}
.modal-btn-row{display:flex;gap:12px;justify-content:center;margin-top:14px;}
.modal-btn{background-image:url('https://aden-rpg.pages.dev/assets/botao.webp');background-size:cover;background-position:center;background-color:transparent;border:none;color:#e0dccc;font-weight:bold;font-family:'Cinzel',serif;padding:12px 22px;cursor:pointer;font-size:.9em;text-shadow:1px 1px 2px #000;min-width:90px;}
.modal-btn:hover{opacity:.9;}

#pvpModal .modal-content{max-width:520px;background:#160f22;border-color:#74b;}
#pvpModal h2{color:#daf;text-shadow:0 0 8px #a4f;}
.pvp-arena{display:flex;justify-content:space-around;align-items:flex-start;gap:10px;margin:12px 0;}
.pvp-fighter{display:flex;flex-direction:column;align-items:center;gap:6px;flex:1;max-width:160px;}
.pvp-fighter-name{font-size:.7em;color:#ddd;font-weight:bold;}
.pvp-fighter img{width:70px;height:70px;border-radius:50%;border:3px solid #85a;object-fit:cover;background:#222;}
.pvp-vs{font-size:1.6em;color:#fa4;align-self:center;font-weight:bold;text-shadow:0 0 10px #f60;}
.pvp-hp-bg{width:100%;height:14px;background:#333;border-radius:7px;overflow:hidden;}
.pvp-hp-fill{height:100%;background:linear-gradient(90deg,#c24,#f46);border-radius:7px;transition:width .3s;}
.pvp-hp-txt{font-size:.6em;color:#ccc;}
#pvpCountdown{font-size:.95em;color:#fd8;margin:6px 0;font-weight:bold;}

/* ‚îÄ‚îÄ DAMAGE NUMBERS (estilo mina) ‚îÄ‚îÄ‚îÄ */
.damage-number{font-family:Georgia,serif;font-size:23px;font-weight:bold;color:#fff;text-shadow:2px 2px 4px #000;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;white-space:nowrap;animation:floating-damage 1.5s ease-out forwards;}
.crit-damage-number{font-family:Georgia,serif;font-size:2.1em;color:red;text-shadow:-1px -1px 0 yellow,1px -1px 0 yellow,-1px 1px 0 yellow,1px 1px 0 yellow,-2px -2px 0 yellow,2px -2px 0 yellow,-2px 2px 0 yellow,2px 2px 0 yellow;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;white-space:nowrap;animation:floating-damage-crit 1.5s ease-out forwards;}
.evade-text{font-size:1.4em;color:white;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;white-space:nowrap;text-shadow:1px 1px 2px #000,-1px -1px 2px #000;animation:floating-damage 2s ease-out forwards;}
@keyframes floating-damage{0%{opacity:1;transform:translate(-50%,-50%) scale(1);}100%{opacity:0;transform:translate(-50%,-150%) scale(1.3);}}
@keyframes floating-damage-crit{0%{opacity:1;transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-80%) scale(1.4);}100%{opacity:0;transform:translate(-50%,-160%) scale(1.2);}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px) rotate(-3deg)}40%{transform:translateX(8px) rotate(3deg)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
.shake-animation{animation:shake .35s cubic-bezier(.36,.07,.19,.97) both!important;backface-visibility:hidden;}

/* ‚îÄ‚îÄ KILL BANNER ‚îÄ‚îÄ‚îÄ */
#huntKillBanner{position:fixed;top:58px;right:0;background:linear-gradient(90deg,rgba(180,30,0,.92),rgba(180,80,0,.92));color:#fff;padding:9px 22px;border-radius:6px 0 0 6px;z-index:25000;font-weight:bold;white-space:nowrap;text-shadow:1px 1px 2px #000;box-shadow:0 0 12px rgba(0,0,0,.6);opacity:0;transform:translateX(100%);transition:opacity .3s;}
#huntKillBanner.show{opacity:1;animation:huntBannerSlide 26s linear forwards;}
@keyframes huntBannerSlide{0%{transform:translateX(100%);}100%{transform:translateX(calc(-100% - 5px));}}

/* ‚îÄ‚îÄ PVP FIGHTER (reposicionado) ‚îÄ‚îÄ‚îÄ */
.pvp-fighter{position:relative;}
.pvp-fighter img{width:70px;height:70px;border-radius:50%;border:3px solid #85a;object-fit:cover;background:#222;}

#eliminatedModal .modal-content{border-color:#c22;background:#1a0808;}
#eliminatedModal h2{color:#f66;text-shadow:0 0 8px #f00;}

/* ‚îÄ‚îÄ DEAD PENALTY OVERLAY ‚îÄ‚îÄ‚îÄ */
#deadPenaltyOverlay{display:none;position:fixed;bottom:75px;left:50%;transform:translateX(-50%);z-index:1500;flex-direction:column;align-items:center;gap:4px;pointer-events:none;}
#deadPenaltyAvatarWrap{position:relative;}
#deadPenaltyAvatar{width:72px;height:72px;border-radius:50%;border:3px solid #c22;filter:grayscale(80%) brightness(0.45);object-fit:cover;display:block;}
#deadPenaltyTimer{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6666;font-weight:bold;font-size:.82em;text-align:center;text-shadow:0 0 6px #000,1px 1px 2px #000;background:rgba(0,0,0,.62);border-radius:5px;padding:2px 5px;white-space:nowrap;letter-spacing:1px;}
#deadPenaltyLabel{color:#f88;font-size:.58em;font-weight:bold;text-shadow:1px 1px 2px #000;background:rgba(0,0,0,.65);border-radius:4px;padding:2px 8px;}
@keyframes deadPulse{0%,100%{opacity:1}50%{opacity:.55}}
#deadPenaltyOverlay.active{animation:deadPulse 1.6s ease-in-out infinite;}

#rewardsModal .modal-content{border-color:#c92;background:#1c1808;max-width:460px;}
#rewardsModal h2{color:#fd8;text-shadow:0 0 8px #fa0;}
.region-rewards-block{margin:10px 0;text-align:left;}
.region-rewards-title{color:#fc8;font-size:.8em;font-weight:bold;border-bottom:1px solid #432;padding-bottom:4px;margin-bottom:6px;}
.reward-item-row{display:flex;align-items:center;gap:12px;margin:6px 0;background:rgba(255,255,255,.04);border:1px solid #432;border-radius:6px;padding:7px 10px;}
.reward-item-row img{width:44px;height:44px;border-radius:6px;border:1px solid #653;background:#111;object-fit:cover;flex-shrink:0;}
.reward-item-info{display:flex;flex-direction:column;gap:2px;}
.reward-item-name{color:#eda;font-size:.75em;font-weight:bold;}
.reward-item-qty{color:#fd8;font-size:1em;font-weight:bold;}
.reward-xp-row{display:flex;align-items:center;gap:8px;margin:8px 0 4px;padding:8px 12px;background:rgba(100,200,100,.08);border:1px solid #2a4a2a;border-radius:6px;}
.reward-xp-row span{color:#afa;font-size:.85em;}
.reward-xp-row strong{color:#8f8;font-size:1.1em;}

#playerTopBar {
  display: flex;
  align-items: flex-start;
  background: linear-gradient(to bottom, #444, #222);
  padding: 5px 5px;
  width: 100%;
  box-sizing: border-box;
  color: #e0dccc;
  font-family: 'Cinzel', serif;
  border-bottom: 2px solid #555;
  flex-wrap: wrap;
  top: 0;
}
</style>
<body>

<div id="playerTopBar">
    <a href="index.html?refresh=true" class="top-bar-link" title="Voltar">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
    </a>
    <span id="pageTitle" style="font-weight: bold; color: #ffc3c3;">Floresta M√≠stica</span>
    <img id="tutorialBtn" src="https://aden-rpg.pages.dev/assets/tutorialbtn.webp" alt="Tutorial" style="width:30px;height:30px;cursor:pointer;">
</div>

<div id="mapContainer"><div id="map"></div></div>

<div id="contentOverlay">
    <div id="huntingHud">
        <div id="huntTimer">03:00:00</div>
        <div id="huntStatus">‚öîÔ∏è Escolha uma √°rea para ca√ßar</div>
        <div id="shieldHudRow" style="display:none;">
            <img src="https://aden-rpg.pages.dev/assets/itens/escudo_de_caca.webp" alt="üõ°">
            <span id="shieldHudText"></span>
        </div>
        <div id="hudBtnRow">
            <button class="hud-btn" id="pauseHuntBtn">Pausar</button>
            <button class="hud-btn" id="activateShieldBtn">üõ° Ativar Escudo (x0)</button>
        </div>
    </div>
</div>

</div>

<div id="loadingOverlay"><div class="loading-spinner"></div></div>

<!-- Banner de kills/mortes globais -->
<div id="huntKillBanner"></div>

<!-- Overlay de penalidade de derrota PvP (cron√¥metro no avatar) -->
<div id="deadPenaltyOverlay">
    <div id="deadPenaltyAvatarWrap">
        <img id="deadPenaltyAvatar" src="" alt="üíÄ">
        <div id="deadPenaltyTimer">03:00</div>
    </div>
    <div id="deadPenaltyLabel">üíÄ Penalidade de derrota</div>
</div>

<!-- √Åudio de fundo PvP (mesma da mina) -->
<audio id="pvpBgMusic" src="https://aden-rpg.pages.dev/assets/mina.mp3" loop preload="none"></audio>

<div id="alertModal" class="modal-container">
    <div class="modal-content">
        <p id="alertMessage" style="font-size:.92em;color:#cec;margin:10px 0 16px;"></p>
        <div class="modal-btn-row"><button id="alertOkBtn" class="modal-btn">OK</button></div>
    </div>
</div>

<div id="confirmModal" class="modal-container">
    <div class="modal-content">
        <h3 id="confirmTitle">Confirmar</h3>
        <p id="confirmMsg" style="color:#cdc;font-size:.88em;"></p>
        <div class="modal-btn-row">
            <button id="confirmNoBtn" class="modal-btn">N√£o</button>
            <button id="confirmYesBtn" class="modal-btn">Sim</button>
        </div>
    </div>
</div>

<div id="pvpModal" class="modal-container">
    <div class="modal-content">
        <h2>‚öîÔ∏è Batalha</h2>
        <div id="pvpCountdown" style="display:none;"></div>
        <div class="pvp-arena">
            <div class="pvp-fighter" id="pvpAttackerSide">
                <div class="pvp-fighter-name" id="pvpAttackerName">Atacante</div>
                <img id="pvpAttackerAvatar" src="" alt="">
                <div class="pvp-hp-bg"><div class="pvp-hp-fill" id="pvpAttackerHpFill" style="width:100%"></div></div>
                <div class="pvp-hp-txt" id="pvpAttackerHpText">0/0</div>
            </div>
            <div class="pvp-vs">VS</div>
            <div class="pvp-fighter" id="pvpDefenderSide">
                <div class="pvp-fighter-name" id="pvpDefenderName">Defensor</div>
                <img id="pvpDefenderAvatar" src="" alt="">
                <div class="pvp-hp-bg"><div class="pvp-hp-fill" id="pvpDefenderHpFill" style="width:100%"></div></div>
                <div class="pvp-hp-txt" id="pvpDefenderHpText">0/0</div>
            </div>
        </div>
    </div>
</div>

<div id="eliminatedModal" class="modal-container">
    <div class="modal-content">
        <h2>üíÄ Eliminado!</h2>
        <p>Voc√™ foi eliminado por <strong id="eliminatedByName">um inimigo</strong>.</p>
        <p style="font-size:.78em;color:#c88;">Sua ca√ßa foi pausada. Clique em uma √°rea para retomar.</p>
        <div class="modal-btn-row"><button id="eliminatedCloseBtn" class="modal-btn">Entendido</button></div>
    </div>
</div>

<!-- Modal de recompensas ‚Äî agrupa por regi√£o -->
<div id="rewardsModal" class="modal-container">
    <div class="modal-content">
        <h2>üéâ Dia de Ca√ßa Completo!</h2>
        <div id="rewardsContent"></div>
        <div class="modal-btn-row"><button id="rewardsCloseBtn" class="modal-btn">Coletar!</button></div>
    </div>
</div>

<div id="huntInfoModal" class="modal-container">
    <div class="modal-content">
        <span class="modal-close" id="huntInfoClose">&times;</span>
        <h2>Floresta M√≠stica</h2>
        <div style="text-align:left;color:#cdc;font-size:.82em;line-height:1.7;">
            <p><strong style="color:#fcc;">Drops:</strong><br>
            <strong>Unic√≥rnio</strong> ‚Üí Chifre de Unic√≥rnio<br>
            <strong>F√™nix</strong> ‚Üí L√°grima de F√™nix<br>
            <strong>S√°tiro</strong> ‚Üí Galho Espiritual<br>
            <strong>Tigre Nix</strong> ‚Üí Pele Animal</p>
            <p><strong style="color:#fd8;">‚è± Tempo:</strong> O contador de <strong>3 horas</strong> √© compartilhado entre todas as regi√µes do jogo. Voc√™ pode dividir o tempo como quiser.</p>
            <p><strong style="color:#afa;">Recompensas:</strong>
            <ul>
            <li><strong>XP:</strong> 350.</li>
            <li><strong>Itens:</strong> Distribu√≠dos proporcionalmente ao tempo gasto em cada regi√£o/spot ao final das 3h.</li></ul></p>
            <p><strong style="color:#acf;">üõ° Escudo:</strong> Protege de PvP por 1 hora por uso (m√°x. 3h).</p>
            <p style="color:#fd8;font-size:.9em;">‚ö†Ô∏è PvP √© livre nesta regi√£o!</p>
            
         <br>  <hr><br>
    <center><h2>Hist√≥ria</h2></center>
    <p>Situada na periferia ocidental da lend√°ria <strong>Selva de √âter</strong>, fazendo fronteira com as terras √©lficas de Elendor, a <strong>Floresta M√≠stica</strong> n√£o √© uma cria√ß√£o natural, mas sim uma consequ√™ncia geol√≥gica da magia. Durante dias sombrios e amea√ßas ao lar dos elfos, o C√≠rculo dos Guardi√µes da Semente tomou uma medida desesperada: sobrecarregaram a "Teia Viva" ‚Äî a rede neural m√°gica que conecta as √Årvores-M√£e.</p>

    <p>Para evitar que o n√∫cleo de Elendor colapsasse sob o peso de tanta energia defensiva, o excesso de mana foi desviado e purgado para uma regi√£o de mata virgem adjacente. O solo, bombardeado por torrentes de energia vital bruta e desenfreada, sofreu uma muta√ß√£o instant√¢nea. A flora n√£o apenas cresceu; ela evoluiu agressivamente, tornando-se um bioma senciente de cores vibrantes e perigos letais, onde a pr√≥pria realidade parece vibrar em uma frequ√™ncia diferente do restante de Aden.</p>

   <center> <h2>O Fen√¥meno: A Satura√ß√£o Prism√°tica</h2></center>
    <p>Diferente da harmonia cultivada em Elendor, a Floresta M√≠stica √© regida pelo caos da superabund√¢ncia. O ar √© denso, carregado de esporos luminosos que distorcem a percep√ß√£o de dist√¢ncia e tempo. Ali, a vida n√£o segue o ciclo natural de nascimento e morte, mas sim de transmuta√ß√£o constante. √â um lugar onde a natureza n√£o √© passiva; ela √© uma predadora voraz que busca consumir qualquer fonte externa de magia para continuar sua expans√£o.</p>

    <p>Esta satura√ß√£o de energia atraiu e alterou permanentemente a fauna local. As criaturas que habitam a Floresta M√≠stica n√£o s√£o monstros das sombras, mas bestas de pura luz e f√∫ria elemental, existindo em um estado perp√©tuo de superestimula√ß√£o m√°gica.</p>

    <center><h2>Os Habitantes: Guardi√µes da Luz Ca√≥tica</h2></center>
    <p>As entidades que vagam por entre as √°rvores de casca prateada s√£o manifesta√ß√µes f√≠sicas desse poder excedente.</p>

    <p><strong>O Unic√≥rnio Cintilante:</strong> Outrora um s√≠mbolo de pureza, na Floresta M√≠stica ele √© uma tempestade galopante. Seu chifre n√£o √© apenas osso, mas um para-raios de mana solidificado, capaz de canalizar a energia inst√°vel do ambiente para obliterar intrusos.</p>

    <p><strong>A F√™nix do √âter:</strong> Diferente de suas primas lend√°rias, esta ave n√£o renasce das cinzas por escolha, mas por uma combust√£o interna incontrol√°vel causada pelo excesso de magia em seu sangue. Suas l√°grimas, procuradas por alquimistas, s√£o a √∫nica subst√¢ncia capaz de resfriar seu n√∫cleo ardente.</p>

    <p><strong>Os S√°tiros da Vinha F√©rrea:</strong> Corrompidos pela densidade da floresta, estes seres tornaram-se os jardineiros dementes do local. Eles n√£o protegem a natureza por amor, mas por uma simbiose paras√≠tica, utilizando galhos espirituais infundidos com a pr√≥pria alma da floresta para esmagar forasteiros.</p>

    <p><strong>O Tigre Nix:</strong> O predador alfa, cuja pele absorveu as propriedades camale√¥nicas da vegeta√ß√£o mutante, tornando-o um fantasma listrado que ataca com a for√ßa de um deslizamento de terra.</p>

   <center> <h2>O Interesse Econ√¥mico</h2></center>
    <p>Para os habitantes de Zion e os ferreiros de Mitrar, a Floresta M√≠stica √© uma mina de ouro a c√©u aberto, embora mortal. Os materiais colhidos ali ‚Äî chifres carregados de est√°tica, l√°grimas cristalizadas de calor eterno e madeira que pulsa com vida pr√≥pria ‚Äî s√£o os componentes essenciais para a cria√ß√£o de artefatos que exigem uma condutividade m√°gica superior.</p>

    <p>Aventureiros n√£o entram na Floresta para salvar o mundo ou combater o mal antigo; eles entram para colher o fruto do caos, enfrentando a beleza aterrorizante de uma natureza que recebeu poder demais e agora se recusa a ser domada.</p>
            
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{
    const t=document.createElement("div");t.style.cssText="position:absolute;visibility:hidden;font-size:1rem;line-height:1;";t.textContent="M";document.body.appendChild(t);
    const r=t.getBoundingClientRect().height;document.body.removeChild(t);
    const s=document.createElement("style");s.textContent=`html{font-size:${16*(16/r)}px!important;}body{font-size:1.3rem!important;}`;document.head.appendChild(s);
});
</script>

<script type="module">
import { supabase } from './supabaseClient.js';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURA√á√ÉO DA REGI√ÉO ‚Äî altere aqui para cada nova p√°gina
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const REGION_ID = 'floresta_mistica';
const REGION_NAME = 'Floresta M√≠stica';

// Cat√°logo de TODAS as regi√µes (para o modal de recompensas)
// Adicione aqui as outras regi√µes conforme criar as p√°ginas
const ALL_REGIONS = {
    floresta_mistica: { name:'Floresta M√≠stica' },
    // montanhas: { name:'Montanhas' },
};

// Cat√°logo de TODOS os itens de drop de todas as regi√µes (para exibir no modal)
const ALL_DROPS = {
    84: { name:'Chifre de Unic√≥rnio', img:'https://aden-rpg.pages.dev/assets/itens/chifre_de_unicornio.webp' },
    71: { name:'L√°grima de F√™nix',    img:'https://aden-rpg.pages.dev/assets/itens/lagrima_de_fenix.webp'    },
    74: { name:'Galho Espiritual',    img:'https://aden-rpg.pages.dev/assets/itens/galho_espiritual.webp'    },
    67: { name:'Pele Animal',               img:'https://aden-rpg.pages.dev/assets/itens/pele_animal.webp'               },
    // adicione outros drops aqui
};

const SPOTS = [
    { id:'unicornio', name:'Unic√≥rnio',  top:320, left:190,  width:450, height:450,
      itemId:84, mobImg:'https://aden-rpg.pages.dev/assets/unicornio.webp', labelColor:'#ffccee' },
    { id:'fenix',    name:'F√™nix',       top:430, left:830, width:500, height:430,
      itemId:71, mobImg:'https://aden-rpg.pages.dev/assets/fenix.webp',     labelColor:'#ffddaa' },
    { id:'satiro',   name:'S√°tiro',      top:880, left:100, width:600, height:550,
      itemId:74, mobImg:'https://aden-rpg.pages.dev/assets/satiro.webp',    labelColor:'#aaffaa' },
    { id:'tigrenix', name:'Tigre Nix',   top:1120, left:850, width:500, height:360,
      itemId:51, mobImg:'https://aden-rpg.pages.dev/assets/tigre_nix.webp', labelColor:'#bbbbff' },
];

const SHIELD_ITEM_ID = 85;
const SHIELD_IMG     = 'https://aden-rpg.pages.dev/assets/itens/escudo_de_caca.webp';
const DEFAULT_AVATAR = 'https://aden-rpg.pages.dev/assets/default_avatar.png';
const DAILY_LIMIT    = 10800; // 3h globais ‚Äî mesmo valor do SQL
const SYNC_MS        = 60 * 1000; // 1 minuto ‚Äî mais responsivo para PvP
const SPOT_LOCK_MS   = 15 * 60 * 1000; // 15 minutos de lock por spot
const ACTIVITY_KEY   = 'aden_activity_state';

// ‚îÄ‚îÄ ACTIVITY STATE (cache local compartilhado com mines.js) ‚îÄ
function getActivity(){
    try{
        const a=JSON.parse(localStorage.getItem(ACTIVITY_KEY));
        if(!a)return null;
        // Expira ap√≥s 6 horas sem intera√ß√£o (previne bloqueio por crash)
        if(a.started_at&&(Date.now()-a.started_at)>6*60*60*1000){localStorage.removeItem(ACTIVITY_KEY);return null;}
        return a;
    }catch{return null;}
}
function setActivityHunting(spotId, forceResetLock = false){
    const cur=getActivity()||{};
    // forceResetLock=true (ap√≥s ataque) sempre reinicia o timer de 15 min do spot
    const keepTimer = !forceResetLock && cur.type==='hunting' && cur.spot_id===spotId;
    localStorage.setItem(ACTIVITY_KEY,JSON.stringify({
        type:'hunting',region:REGION_NAME,spot_id:spotId,
        spot_started_at: keepTimer ? cur.spot_started_at : Date.now(),
        started_at:Date.now()
    }));
}
function clearActivity(){localStorage.removeItem(ACTIVITY_KEY);}
function canSwitchSpot(){
    const a=getActivity();
    if(!a||a.type!=='hunting'||!a.spot_started_at)return true;
    return(Date.now()-a.spot_started_at)>=SPOT_LOCK_MS;
}
function fmtLockTime(){
    const a=getActivity();
    if(!a||!a.spot_started_at)return'0:00';
    const ms=Math.max(0,SPOT_LOCK_MS-(Date.now()-a.spot_started_at));
    const total=Math.ceil(ms/1000);
    const m=Math.floor(total/60),s=total%60;
    return`${m}:${String(s).padStart(2,'0')}`;
}

// ‚îÄ‚îÄ ESTADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let userId=null, playerData=null, currentSession=null;
let isHunting=false, isPvpOnly=false, currentSpotId=null, localSecondsLeft=DAILY_LIMIT;
let pvpOnlyExitTimer=null, pvpOnlySecondsLeft=900, pvpOnlyTimerInterval=null;
let shieldUntil=null, cachedShieldQty=0;
let huntTimerInterval=null, shieldTimerInterval=null, syncInterval=null;
let otherPlayers=[], wanderTimers=[];

// ‚îÄ‚îÄ DEAD STATE (derrota em PvP ‚Äî 3 minutos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let deadUntil=null; // timestamp ms
let deadTimer=null;
let deadOverlayInterval=null;
function isPlayerDead(){return deadUntil&&Date.now()<deadUntil;}

function _startDeadOverlay(){
    const overlay=document.getElementById('deadPenaltyOverlay');
    if(!overlay)return;
    const avImg=document.getElementById('deadPenaltyAvatar');
    if(avImg&&playerData)avImg.src=playerData.avatar_url||DEFAULT_AVATAR;
    overlay.style.display='flex';
    overlay.classList.add('active');
    const timerEl=document.getElementById('deadPenaltyTimer');
    clearInterval(deadOverlayInterval);
    const tick=()=>{
        const remaining=Math.max(0,Math.ceil((deadUntil-Date.now())/1000));
        const m=Math.floor(remaining/60),s=remaining%60;
        if(timerEl)timerEl.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        if(remaining<=0){
            clearInterval(deadOverlayInterval);deadOverlayInterval=null;
            overlay.style.display='none';overlay.classList.remove('active');
        }
    };
    tick();
    deadOverlayInterval=setInterval(tick,1000);
}

function setPlayerDead(){
    deadUntil=Date.now()+3*60*1000;
    localStorage.setItem(ACTIVITY_KEY,JSON.stringify({
        type:'hunting',region:REGION_NAME,spot_id:currentSpotId||'__dead__',
        pvp_dead:true,dead_until:deadUntil,started_at:Date.now()
    }));
    clearTimeout(deadTimer);
    deadTimer=setTimeout(()=>{
        deadUntil=null;
        if(currentSpotId){
            isHunting=false;isPvpOnly=false;stopLocalTimer();removePlayerFromSpot();currentSpotId=null;
            clearTimeout(pvpOnlyExitTimer);
        }
        clearActivity();updateHuntingHUD();
    },3*60*1000);
    _startDeadOverlay();
}
function clearDeadState(){
    deadUntil=null;clearTimeout(deadTimer);deadTimer=null;
    clearInterval(deadOverlayInterval);deadOverlayInterval=null;
    const overlay=document.getElementById('deadPenaltyOverlay');
    if(overlay){overlay.style.display='none';overlay.classList.remove('active');}
}

// ‚îÄ‚îÄ KILL BANNER QUEUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _killBannerQueue=[];
let _killBannerShowing=false;
function createKillBannerUI(){
    let el=document.getElementById('huntKillBanner');
    if(!el){el=document.createElement('div');el.id='huntKillBanner';document.body.appendChild(el);}
}
function pushKillNotif(html){
    _killBannerQueue.push(html);
    if(!_killBannerShowing)_processKillQueue();
}
function _processKillQueue(){
    if(_killBannerShowing||_killBannerQueue.length===0)return;
    _killBannerShowing=true;
    const el=document.getElementById('huntKillBanner');
    if(!el){_killBannerShowing=false;return;}
    el.innerHTML=_killBannerQueue.shift();
    el.classList.remove('show');
    void el.offsetWidth;
    el.classList.add('show');
    const done=()=>{
        el.classList.remove('show');
        el.removeEventListener('animationend',done);
        _killBannerShowing=false;
        setTimeout(_processKillQueue,400);
    };
    el.addEventListener('animationend',done,{once:true});
}

// ‚îÄ‚îÄ INDEXEDDB (mesmo do mercador.js) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const IDB_NAME='aden_inventory_db',IDB_STORE='inventory_store',IDB_VERSION=47;
function openIdb(){return new Promise((res,rej)=>{const req=indexedDB.open(IDB_NAME,IDB_VERSION);req.onerror=()=>rej(req.error);req.onsuccess=e=>res(e.target.result);req.onupgradeneeded=()=>{};});}
async function getItemQtyFromCache(id){try{const db=await openIdb();if(!db.objectStoreNames.contains(IDB_STORE))return 0;const tx=db.transaction(IDB_STORE,'readonly');const all=await new Promise((res,rej)=>{const r=tx.objectStore(IDB_STORE).getAll();r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});return all.filter(i=>i.items?.item_id===id).reduce((s,i)=>s+(i.quantity||0),0);}catch{return 0;}}
async function updateCacheQty(id,delta){try{const db=await openIdb();if(!db.objectStoreNames.contains(IDB_STORE))return;const tx=db.transaction(IDB_STORE,'readwrite'),store=tx.objectStore(IDB_STORE);const all=await new Promise((res,rej)=>{const r=store.getAll();r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});const m=all.filter(i=>i.items?.item_id===id);if(!m.length)return;let rem=Math.abs(delta);if(delta<0){for(const item of m){if(rem<=0)break;if(item.quantity>=rem){item.quantity-=rem;rem=0;if(item.quantity<=0)store.delete(item.id);else store.put(item);}else{rem-=item.quantity;store.delete(item.id);}}}else{const item=m[0];item.quantity=(item.quantity||0)+delta;store.put(item);}}catch(e){console.warn('[floresta] IDB fail',e);}}

// ‚îÄ‚îÄ √ÅUDIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
const audioBufs={};
const SRC={normal:'https://aden-rpg.pages.dev/assets/normal_hit.mp3',critical:'https://aden-rpg.pages.dev/assets/critical_hit.mp3',evade:'https://aden-rpg.pages.dev/assets/evade.mp3',ambient:'https://aden-rpg.pages.dev/assets/floresta.mp3'};
async function preload(n){try{const r=await fetch(SRC[n],{cache:'force-cache'});if(!r.ok)return;const ab=await r.arrayBuffer();audioBufs[n]=await new Promise((res,rej)=>audioCtx.decodeAudioData(ab,res,rej));}catch{}}
function playSound(n){try{if(audioCtx.state==='suspended')audioCtx.resume();}catch{}const buf=audioBufs[n];if(!buf)return;try{const s=audioCtx.createBufferSource();s.buffer=buf;s.connect(audioCtx.destination);s.start(0);s.onended=()=>{try{s.disconnect();}catch{}};}catch{}}
const amb=new Audio(SRC.ambient);amb.volume=0.12;amb.loop=true;
document.addEventListener('click',()=>{try{if(audioCtx.state==='suspended')audioCtx.resume();}catch{}amb.play().catch(()=>{});},{once:true});
document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='hidden'){if(!amb.paused){amb.pause();amb._was=true;}}else{if(amb._was){amb.play().catch(()=>{});amb._was=false;}}});

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getUserId(){try{for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k?.startsWith('sb-')&&k.endsWith('-auth-token')){const s=JSON.parse(localStorage.getItem(k));if(s?.user?.id)return s.user.id;}}}catch{}try{const c=localStorage.getItem('player_data_cache');if(c){const p=JSON.parse(c);if(p?.data?.id)return p.data.id;}}catch{}try{const{data}=await supabase.auth.getSession();return data?.session?.user?.id||null;}catch{return null;}}
async function getPlayerData(){try{if(window.currentPlayerData?.id)return window.currentPlayerData;const c=localStorage.getItem('player_data_cache');if(c){const p=JSON.parse(c);if(p?.data)return p.data;}}catch{}return null;}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtTime(s){s=Math.max(0,Math.floor(s));return`${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;}
function esc(s){if(!s&&s!==0)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}
function showLoading(){document.getElementById('loadingOverlay').style.display='flex';}
function hideLoading(){document.getElementById('loadingOverlay').style.display='none';}
function showAlert(msg){return new Promise(r=>{const m=document.getElementById('alertModal'),el=document.getElementById('alertMessage'),btn=document.getElementById('alertOkBtn');el.innerHTML=msg;m.style.display='flex';const close=()=>{m.style.display='none';btn.onclick=null;r();};btn.onclick=close;m.addEventListener('click',e=>{if(e.target===m)close();},{once:true});});}
function showConfirm(title,msg){return new Promise(r=>{const m=document.getElementById('confirmModal');document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMsg').innerHTML=msg;m.style.display='flex';const yes=document.getElementById('confirmYesBtn'),no=document.getElementById('confirmNoBtn');const done=v=>{m.style.display='none';yes.onclick=null;no.onclick=null;r(v);};yes.onclick=()=>done(true);no.onclick=()=>done(false);m.addEventListener('click',e=>{if(e.target===m)done(false);},{once:true});});}

// Modal com cron√¥metro regressivo em tempo real (atualiza a cada segundo)
function showLiveCountdownAlert(msgFn){
    return new Promise(r=>{
        const m=document.getElementById('alertModal'),el=document.getElementById('alertMessage'),btn=document.getElementById('alertOkBtn');
        const tick=()=>{el.innerHTML=msgFn();};
        tick();
        m.style.display='flex';
        const iv=setInterval(tick,1000);
        const close=()=>{clearInterval(iv);m.style.display='none';btn.onclick=null;r();};
        btn.onclick=close;
        m.addEventListener('click',e=>{if(e.target===m)close();},{once:true});
    });
}

// ‚îÄ‚îÄ ESCUDO (global ‚Äî sem region_id) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initShieldFromCache(){cachedShieldQty=await getItemQtyFromCache(SHIELD_ITEM_ID);updateShieldBtn();}
function updateShieldBtn(){const btn=document.getElementById('activateShieldBtn');if(!btn)return;btn.textContent=`üõ° Ativar Escudo (x${cachedShieldQty})`;btn.disabled=cachedShieldQty<=0;}
function isShieldActive(){return shieldUntil&&shieldUntil>new Date();}
function startShieldTimer(){clearInterval(shieldTimerInterval);const row=document.getElementById('shieldHudRow'),txt=document.getElementById('shieldHudText');if(!row||!txt)return;const tick=()=>{const diff=Math.max(0,Math.floor((shieldUntil-new Date())/1000));if(diff<=0){clearInterval(shieldTimerInterval);row.style.display='none';updateMyShieldIcon(false);return;}row.style.display='flex';txt.textContent=`Protegido por ${fmtTime(diff)}`;};tick();shieldTimerInterval=setInterval(tick,1000);}
async function handleActivateShield(){
    if(cachedShieldQty<=0){await showAlert('Voc√™ n√£o tem <strong>Escudo de Ca√ßa</strong> no invent√°rio!');return;}
    const ok=await showConfirm('üõ° Escudo de Ca√ßa',`Ativar Escudo de Ca√ßa?<br><small style="color:#aab;">Protege de PvP por 1h. M√°x. 3h acumuladas. Voc√™ tem <strong>${cachedShieldQty}</strong>.</small>`);
    if(!ok)return;
    cachedShieldQty--;updateShieldBtn();await updateCacheQty(SHIELD_ITEM_ID,-1);
    showLoading();
    try{
        // RPC activate_hunt_shield agora n√£o precisa de p_region_id
        const{data,error}=await supabase.rpc('activate_hunt_shield',{p_player_id:userId});
        if(error)throw error;
        if(!data?.success){cachedShieldQty++;updateShieldBtn();await updateCacheQty(SHIELD_ITEM_ID,1);await showAlert(data?.message||'Erro.');return;}
        shieldUntil=new Date(data.shield_until);startShieldTimer();updateMyShieldIcon(true);
        await showAlert('üõ° <strong>Escudo ativado!</strong>');
    }catch(e){cachedShieldQty++;updateShieldBtn();await updateCacheQty(SHIELD_ITEM_ID,1);await showAlert('Erro: '+(e.message||''));}
    finally{hideLoading();}
}
function updateMyShieldIcon(active){const el=document.getElementById('myShieldIcon');if(el)el.style.display=active?'block':'none';}

// ‚îÄ‚îÄ DRAG DO MAPA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function enableMapInteraction(){const cont=document.getElementById('mapContainer'),map=document.getElementById('map');if(!map||!cont)return;let drag=false,sx,sy,cx=0,cy=0,vx=0,vy=0,lt=0,aId=null;const limits=()=>{const cr=cont.getBoundingClientRect(),m=map.style.transform.match(/scale\(([^)]+)\)/),sc=m?parseFloat(m[1]):1.1;return{minX:Math.min(0,cr.width-1500*sc),maxX:0,minY:Math.min(0,cr.height-1500*sc),maxY:0};};const setPos=(x,y)=>{const L=limits();cx=Math.max(L.minX,Math.min(x,L.maxX));cy=Math.max(L.minY,Math.min(y,L.maxY));const m=map.style.transform.match(/scale\(([^)]+)\)/);map.style.transform=`translate(${cx}px,${cy}px) ${m?`scale(${m[1]})`:'scale(1.1)'}`;};const inertia=()=>{cancelAnimationFrame(aId);if(drag)return;vx*=0.94;vy*=0.94;setPos(cx+vx,cy+vy);if(Math.abs(vx)>0.4||Math.abs(vy)>0.4)aId=requestAnimationFrame(inertia);};const startDrag=e=>{if(e.touches?.length>1)return;drag=true;map.style.cursor='grabbing';sx=e.clientX??e.touches[0].clientX;sy=e.clientY??e.touches[0].clientY;vx=vy=0;lt=performance.now();cancelAnimationFrame(aId);};const onDrag=e=>{if(!drag)return;e.preventDefault();const nx=e.clientX??e.touches[0].clientX,ny=e.clientY??e.touches[0].clientY,dt=performance.now()-lt;if(dt>0){vx=(nx-sx)/dt;vy=(ny-sy)/dt;}setPos(cx+(nx-sx),cy+(ny-sy));sx=nx;sy=ny;lt=performance.now();};const endDrag=()=>{drag=false;map.style.cursor='grab';if(Math.abs(vx)>0.2||Math.abs(vy)>0.2){vx*=10;vy*=10;inertia();}};map.addEventListener('mousedown',startDrag,{passive:true});window.addEventListener('mousemove',onDrag,{passive:false});window.addEventListener('mouseup',endDrag,{passive:true});map.addEventListener('touchstart',startDrag,{passive:true});window.addEventListener('touchmove',onDrag,{passive:false});window.addEventListener('touchend',endDrag,{passive:true});map.style.cursor='grab';}

// ‚îÄ‚îÄ WANDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startWander(el,w,h,delay){const move=()=>{el.style.transition='left 3s ease-in-out,top 3s ease-in-out';el.style.left=Math.max(0,Math.random()*(w-70))+'px';el.style.top=Math.max(0,Math.random()*(h-90))+'px';wanderTimers.push(setTimeout(pause,3100+Math.random()*800));};const pause=()=>{wanderTimers.push(setTimeout(move,5000+Math.random()*2000));};wanderTimers.push(setTimeout(move,delay));}

// ‚îÄ‚îÄ SPOTS + MOBS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSpots(){const map=document.getElementById('map');map.querySelectorAll('.hunt-spot').forEach(e=>e.remove());SPOTS.forEach(spot=>{const el=document.createElement('div');el.className='hunt-spot';el.id=`spot-${spot.id}`;Object.assign(el.style,{top:spot.top+'px',left:spot.left+'px',width:spot.width+'px',height:spot.height+'px'});const lbl=document.createElement('div');lbl.className='spot-label';lbl.textContent=spot.name;lbl.style.color=spot.labelColor||'#fff';el.appendChild(lbl);for(let i=0;i<5;i++){const col=i%3,row=Math.floor(i/3);const wrap=document.createElement('div');wrap.className='mob-wrapper';Object.assign(wrap.style,{left:Math.min(10+col*80+Math.random()*20,spot.width-70)+'px',top:Math.min(15+row*80+Math.random()*20,spot.height-90)+'px'});const nm=document.createElement('div');nm.className='mob-name';nm.textContent=spot.name;nm.style.color=spot.labelColor||'#fcc';const av=document.createElement('img');av.className='mob-avatar';av.src=spot.mobImg;av.onerror=()=>{av.src=DEFAULT_AVATAR;};wrap.appendChild(nm);wrap.appendChild(av);el.appendChild(wrap);startWander(wrap,spot.width,spot.height,i*1400+Math.random()*3000);}el.addEventListener('click',e=>{if(e.target.closest('.other-player-wrapper'))return;handleSpotClick(spot);});map.appendChild(el);});}

// ‚îÄ‚îÄ AVATAR DO JOGADOR NO SPOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPlayerOnSpot(spotId){document.querySelectorAll('.player-avatar-wrapper').forEach(e=>e.remove());if(!spotId||!playerData)return;const spotEl=document.getElementById(`spot-${spotId}`);if(!spotEl)return;const spot=SPOTS.find(s=>s.id===spotId);const wrap=document.createElement('div');wrap.className='player-avatar-wrapper';Object.assign(wrap.style,{right:'10px',bottom:'10px',left:'auto',top:'auto'});const si=document.createElement('img');si.id='myShieldIcon';si.className='player-shield-icon';si.src=SHIELD_IMG;si.style.display=isShieldActive()?'block':'none';wrap.appendChild(si);const nm=document.createElement('div');nm.className='player-name-label';nm.textContent=playerData.name||'Voc√™';wrap.appendChild(nm);const av=document.createElement('img');av.className='player-spot-avatar';av.src=playerData.avatar_url||DEFAULT_AVATAR;av.onerror=()=>{av.src=DEFAULT_AVATAR;};wrap.appendChild(av);spotEl.appendChild(wrap);if(spot)startWander(wrap,spot.width,spot.height,800);}
function removePlayerFromSpot(){document.querySelectorAll('.player-avatar-wrapper').forEach(e=>e.remove());}

// ‚îÄ‚îÄ OUTROS JOGADORES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOtherPlayers(players){document.querySelectorAll('.other-player-wrapper').forEach(e=>e.remove());players.forEach(p=>{if(!p.current_spot)return;const spotEl=document.getElementById(`spot-${p.current_spot}`);if(!spotEl)return;const spot=SPOTS.find(s=>s.id===p.current_spot);const wrap=document.createElement('div');wrap.className='other-player-wrapper';wrap.dataset.playerId=p.id;Object.assign(wrap.style,{left:(10+Math.random()*Math.max(10,(spot?.width||120)-80))+'px',top:(10+Math.random()*Math.max(10,(spot?.height||120)-90))+'px'});const shActive=p.shield_until&&new Date(p.shield_until)>new Date();if(shActive){const si=document.createElement('img');si.className='other-player-shield';si.src=SHIELD_IMG;wrap.appendChild(si);}const nm=document.createElement('div');nm.className='other-player-name';nm.textContent=esc(p.name)||'?';wrap.appendChild(nm);const av=document.createElement('img');av.className='other-player-avatar'+(p.is_eliminated?' eliminated':'');av.src=p.avatar_url||DEFAULT_AVATAR;av.onerror=()=>{av.src=DEFAULT_AVATAR;};wrap.appendChild(av);if(p.is_eliminated){const lbl=document.createElement('div');lbl.className='other-eliminated-label';lbl.textContent='Eliminado';wrap.appendChild(lbl);}else{wrap.addEventListener('click',e=>{e.stopPropagation();handleAttackPlayer(p);});if(p.is_hunting&&spot)startWander(wrap,spot.width,spot.height,Math.random()*4000);}spotEl.appendChild(wrap);});}

// ‚îÄ‚îÄ TIMER GLOBAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateTimerDisplay(){const el=document.getElementById('huntTimer');if(el)el.textContent=isPvpOnly?fmtTime(pvpOnlySecondsLeft):fmtTime(localSecondsLeft);}
function startLocalTimer(){clearInterval(huntTimerInterval);huntTimerInterval=setInterval(()=>{if(!isHunting)return;if(localSecondsLeft<=0){localSecondsLeft=0;clearInterval(huntTimerInterval);updateTimerDisplay();onHuntComplete();return;}localSecondsLeft--;updateTimerDisplay();},1000);}
function stopLocalTimer(){clearInterval(huntTimerInterval);huntTimerInterval=null;}

// ‚îÄ‚îÄ TIMER PvP PURO (15 min) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startPvpOnlyTimer(){
    clearInterval(pvpOnlyTimerInterval);
    pvpOnlySecondsLeft=900;updateTimerDisplay();
    pvpOnlyTimerInterval=setInterval(()=>{
        if(!isPvpOnly){clearInterval(pvpOnlyTimerInterval);return;}
        if(pvpOnlySecondsLeft<=0){clearInterval(pvpOnlyTimerInterval);exitPvpOnlyMode();return;}
        pvpOnlySecondsLeft--;updateTimerDisplay();
    },1000);
}
function stopPvpOnlyTimer(){clearInterval(pvpOnlyTimerInterval);pvpOnlyTimerInterval=null;}
function resetPvpOnlyTimer(){
    // Chamado ap√≥s vit√≥ria em PvP ‚Äî renova os 15 min
    clearTimeout(pvpOnlyExitTimer);
    pvpOnlyExitTimer=setTimeout(exitPvpOnlyMode,SPOT_LOCK_MS);
    startPvpOnlyTimer();
    // Atualiza pvp_only_entered_at no servidor (fire and forget)
    supabase.rpc('start_pvp_only',{p_player_id:userId,p_region_id:REGION_ID,p_spot:currentSpotId}).catch(()=>{});
}

function updateHuntingHUD(){
    const hud=document.getElementById('huntingHud'),status=document.getElementById('huntStatus'),pauseBtn=document.getElementById('pauseHuntBtn');
    updateSpotStyles();
    if(currentSession?.rewards_claimed){hud.style.display='flex';status.textContent='‚úÖ Recompensas coletadas hoje!';pauseBtn.style.display='none';return;}

    // Modo PvP puro (tempo esgotado, entrou s√≥ para pvp)
    if(isPvpOnly&&currentSpotId){
        hud.style.display='flex';pauseBtn.style.display='block';
        updateTimerDisplay();
        const spotName=SPOTS.find(s=>s.id===currentSpotId)?.name||currentSpotId;
        status.textContent=`‚öîÔ∏è Modo PvP: ${spotName}`;
        pauseBtn.textContent='Sair';pauseBtn.disabled=false;
        return;
    }

    if(localSecondsLeft<=0&&!isHunting){hud.style.display='none';return;}
    hud.style.display='flex';pauseBtn.style.display='block';updateTimerDisplay();
    if(isHunting&&currentSpotId){status.textContent=`‚öîÔ∏è Ca√ßando: ${SPOTS.find(s=>s.id===currentSpotId)?.name||currentSpotId}`;pauseBtn.textContent='Pausar';pauseBtn.disabled=false;}
    else{status.textContent='‚è∏Ô∏è Pausado ‚Äî clique num spot para continuar';pauseBtn.textContent='Pausado';pauseBtn.disabled=true;}
}
function updateSpotStyles(){
    SPOTS.forEach(s=>{
        const el=document.getElementById(`spot-${s.id}`);
        if(!el)return;
        if((isHunting||isPvpOnly)&&currentSpotId===s.id)el.classList.add('active-spot');
        else el.classList.remove('active-spot');
    });
}

// ‚îÄ‚îÄ CONCLUS√ÉO DO DIA (timer global zera) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function onHuntComplete(){
    isHunting=false;stopLocalTimer();updateHuntingHUD();showLoading();
    try{
        // finish_daily_hunt distribui recompensas de TODAS as regi√µes visitadas
        const{data,error}=await supabase.rpc('finish_daily_hunt',{p_player_id:userId});
        if(error)throw error;
        if(data?.success)showRewardsModal(data);
        else await showAlert(data?.message||'Erro ao finalizar.');
    }catch(e){await showAlert('Erro ao finalizar. Tente novamente.');}
    finally{hideLoading();}
}

// ‚îÄ‚îÄ CLICK NO SPOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function handleSpotClick(spot){
    if(currentSession?.rewards_claimed){await showAlert('‚úÖ Tempo di√°rio esgotado. Volte amanh√£!');return;}

    // Bloqueado por morte em PvP
    if(isPlayerDead()){
        await showLiveCountdownAlert(()=>{
            const secsLeft=Math.max(0,Math.ceil((deadUntil-Date.now())/1000));
            const m=Math.floor(secsLeft/60),s=secsLeft%60;
            return `üíÄ Voc√™ est√° no ch√£o ap√≥s a derrota.<br>Aguarde <strong>${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</strong> para se recuperar.`;
        });
        return;
    }

    // Tempo de ca√ßa esgotado ‚Äî oferecer modo PvP puro
    if(localSecondsLeft<=0&&!isPvpOnly){
        const ok=await showConfirm('‚öîÔ∏è Modo PvP Puro',
            `Seu tempo de ca√ßada terminou, mas voc√™ pode entrar em <strong>${esc(spot.name)}</strong> exclusivamente para PvP.<br><small style="color:#fd8;">‚è± Voc√™ ter√° <strong>15 minutos</strong>. Vencer um ataque renova o tempo.</small>`);
        if(!ok)return;
        // Entra no modo PvP puro (sem RPC start_hunt ‚Äî tempo j√° acabou)
        clearTimeout(pvpOnlyExitTimer);
        isPvpOnly=true;currentSpotId=spot.id;isHunting=false;
        setActivityHunting(spot.id); // bloqueia minera√ß√£o
        renderPlayerOnSpot(spot.id);
        startPvpOnlyTimer();
        pvpOnlyExitTimer=setTimeout(exitPvpOnlyMode,SPOT_LOCK_MS);
        // Registra no servidor para outros jogadores verem e para o filtro de 15 min
        supabase.rpc('start_pvp_only',{p_player_id:userId,p_region_id:REGION_ID,p_spot:spot.id}).catch(()=>{});
        updateHuntingHUD();
        return;
    }

    // J√° no mesmo spot (ca√ßa normal ou pvp puro) ‚Äî nada a fazer
    if(currentSpotId===spot.id)return;

    // Tentativa de trocar de spot enquanto em modo pvp puro
    if(isPvpOnly){
        if(!canSwitchSpot()){
            await showLiveCountdownAlert(()=>`‚è≥ Voc√™ precisa aguardar mais <strong>${fmtLockTime()}</strong> antes de trocar de spot.`);return;
        }
        clearTimeout(pvpOnlyExitTimer);
        currentSpotId=spot.id;
        setActivityHunting(spot.id);
        renderPlayerOnSpot(spot.id);updateHuntingHUD();
        startPvpOnlyTimer();
        pvpOnlyExitTimer=setTimeout(exitPvpOnlyMode,SPOT_LOCK_MS);
        supabase.rpc('start_pvp_only',{p_player_id:userId,p_region_id:REGION_ID,p_spot:spot.id}).catch(()=>{});
        return;
    }

    // Verifica se est√° minerando em outra p√°gina
    const activity=getActivity();
    if(activity?.type==='mining'){
        await showAlert('‚õèÔ∏è <strong>Voc√™ n√£o √© onipresente...</strong><br>No momento voc√™ est√° minerando.<br>Aguarde o t√©rmino da minera√ß√£o.');
        return;
    }

    // Regra: lock de 15 minutos antes de trocar de spot
    if(isHunting&&currentSpotId&&currentSpotId!==spot.id){
        if(!canSwitchSpot()){
            await showLiveCountdownAlert(()=>`‚è≥ Voc√™ precisa aguardar mais <strong>${fmtLockTime()}</strong> antes de trocar de spot.`);
            return;
        }
    }

    const ok=await showConfirm('√Årea de Ca√ßa',`Ca√ßar na √°rea de <strong>${esc(spot.name)}</strong>?`);
    if(!ok)return;
    showLoading();
    try{
        const{data,error}=await supabase.rpc('start_hunt',{p_player_id:userId,p_region_id:REGION_ID,p_spot:spot.id});
        if(error)throw error;
        if(!data?.success){await showAlert(data?.message||'Erro ao iniciar.');return;}
        localSecondsLeft=Math.max(0,DAILY_LIMIT-(data.total_seconds||0));
        currentSpotId=spot.id;isHunting=true;isPvpOnly=false;
        if(!currentSession)currentSession={};
        currentSession.current_region=REGION_ID;currentSession.current_spot=spot.id;
        setActivityHunting(spot.id);
        renderPlayerOnSpot(spot.id);updateHuntingHUD();startLocalTimer();amb.play().catch(()=>{});
    }catch(e){await showAlert('Erro: '+(e.message||''));}
    finally{hideLoading();}
}

function exitPvpOnlyMode(){
    isPvpOnly=false;currentSpotId=null;
    clearTimeout(pvpOnlyExitTimer);
    stopPvpOnlyTimer();
    clearActivity();removePlayerFromSpot();updateHuntingHUD();
}

// ‚îÄ‚îÄ PAUSAR / SAIR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function handlePauseHunt(){
    // Modo PvP puro ‚Äî "Sair" √© apenas local
    if(isPvpOnly){
        if(!canSwitchSpot()){
            await showLiveCountdownAlert(()=>`‚è≥ Voc√™ precisa aguardar mais <strong>${fmtLockTime()}</strong> antes de sair.`);return;
        }
        exitPvpOnlyMode();
        return;
    }
    if(!isHunting)return;
    // Penalidade de morte ativa?
    if(isPlayerDead()){
        await showLiveCountdownAlert(()=>{
            const secsLeft=Math.max(0,Math.ceil((deadUntil-Date.now())/1000));
            const m=Math.floor(secsLeft/60),s=secsLeft%60;
            return `üíÄ Voc√™ est√° no ch√£o ap√≥s a derrota.<br>Aguarde <strong>${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</strong> para se recuperar.`;
        });
        return;
    }
    if(!canSwitchSpot()){
        await showLiveCountdownAlert(()=>`‚è≥ Voc√™ precisa aguardar mais <strong>${fmtLockTime()}</strong> antes de pausar.`);
        return;
    }
    showLoading();
    try{
        const{data,error}=await supabase.rpc('pause_hunt',{p_player_id:userId});
        if(error)throw error;
        isHunting=false;stopLocalTimer();
        if(data?.total_seconds!==undefined){localSecondsLeft=Math.max(0,DAILY_LIMIT-data.total_seconds);updateTimerDisplay();}
        currentSpotId=null; // permite re-entrar no mesmo spot ap√≥s pausar
        clearActivity();
        removePlayerFromSpot();updateHuntingHUD();
    }catch(e){await showAlert('Erro ao pausar.');}
    finally{hideLoading();}
}

// ‚îÄ‚îÄ PVP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function handleAttackPlayer(target){
    // Verifica se est√° morto (derrota recente)
    if(isPlayerDead()){
        await showLiveCountdownAlert(()=>{
            const secsLeft=Math.max(0,Math.ceil((deadUntil-Date.now())/1000));
            const m=Math.floor(secsLeft/60),s=secsLeft%60;
            return `üíÄ Voc√™ est√° no ch√£o.<br>Aguarde <strong>${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</strong> para se recuperar.`;
        });
        return;
    }
    // Verifica minera√ß√£o em outra aba
    const activity=getActivity();
    if(activity?.type==='mining'){
        await showAlert('‚õèÔ∏è <strong>Voc√™ n√£o √© onipresente...</strong><br>No momento voc√™ est√° minerando.<br>Aguarde o t√©rmino da minera√ß√£o.');return;
    }
    // S√≥ pode atacar se estiver ca√ßando OU em modo PvP puro no mesmo spot
    if(!isHunting&&!isPvpOnly){
        await showAlert('‚öîÔ∏è Voc√™ precisa estar em um spot para atacar outros jogadores.');return;
    }
    if(currentSpotId!==target.current_spot){
        await showAlert('‚öîÔ∏è Voc√™ s√≥ pode atacar jogadores no mesmo spot que voc√™.');return;
    }
    // J√° eliminado localmente?
    if(target.is_eliminated){
        await showAlert(`üíÄ <strong>${esc(target.name)}</strong> j√° foi eliminado.`);return;
    }
    // Escudo do atacante: avisar que perder√° prote√ß√£o
    if(isShieldActive()){
        const okShield=await showConfirm('‚ö†Ô∏è Escudo Ativo',
            `Tem certeza que deseja atacar <strong>${esc(target.name)}</strong>?<br><small style="color:#f88;">Essa a√ß√£o far√° voc√™ perder o Escudo de Ca√ßa.</small>`);
        if(!okShield)return;
        // Remove escudo localmente
        shieldUntil=null;
        clearInterval(shieldTimerInterval);
        document.getElementById('shieldHudRow').style.display='none';
        updateMyShieldIcon(false);
    } else {
        const ok=await showConfirm('PvP',`Deseja atacar <strong>${esc(target.name)}</strong>?`);if(!ok)return;
    }
    showLoading();
    let pvpData=null;
    try{
        const{data,error}=await supabase.rpc('attack_hunting_player',{p_attacker_id:userId,p_defender_id:target.id,p_region_id:REGION_ID});
        if(error)throw error;
        if(!data?.success){
            // Banco confirmou que defensor j√° estava morto ‚Äî atualiza UI local
            if(data?.already_eliminated){
                otherPlayers=otherPlayers.map(p=>p.id===target.id
                    ?{...p,is_eliminated:true,eliminated_by_name:data.eliminated_by_name||'algu√©m'}
                    :p);
                renderOtherPlayers(otherPlayers);
                await showAlert(`üíÄ <strong>${esc(target.name)}</strong> j√° havia sido eliminado por <strong>${esc(data.eliminated_by_name||'algu√©m')}</strong>.`);
                return;
            }
            await showAlert(data?.message||'Erro no PvP.');return;
        }
        pvpData=data;
    }catch(e){await showAlert('Erro no PvP: '+(e.message||''));return;}
    finally{hideLoading();}

    // Anima com loading j√° escondido
    await runPvpAnimation(pvpData);

    const myName=playerData?.name||'Voc√™';
    const regionNameDisplay=REGION_NAME;
    if(pvpData.combat?.winner_id===userId){
        // VIT√ìRIA ‚Äî elimina√ß√£o otimista (banner j√° disparado pelo syncGlobalPvpEvents)
        otherPlayers=otherPlayers.map(p=>p.id===target.id?{...p,is_eliminated:true,eliminated_by_name:myName}:p);
        renderOtherPlayers(otherPlayers);
        // Reseta lock de 15 min
        if(currentSpotId)setActivityHunting(currentSpotId, true);
        if(isPvpOnly)resetPvpOnlyTimer();
    } else {
        // DERROTA ‚Äî fica morto 3 min (banner j√° disparado pelo syncGlobalPvpEvents)
        isHunting=false;isPvpOnly=false;stopLocalTimer();removePlayerFromSpot();
        clearTimeout(pvpOnlyExitTimer);
        if(currentSpotId)setActivityHunting(currentSpotId, true);
        currentSpotId=null;
        clearActivity();updateHuntingHUD();
        setPlayerDead();
    }
    // Sincroniza evento global imediatamente para todos verem
    syncGlobalPvpEvents();
    syncOtherPlayers();
}

async function runPvpAnimation(data){
    const modal=document.getElementById('pvpModal'),combat=data.combat||{},log=combat.battle_log||[];
    const pvpBgMusic=document.getElementById('pvpBgMusic');
    document.getElementById('pvpAttackerName').textContent=data.attacker_name||'Atacante';
    document.getElementById('pvpDefenderName').textContent=data.defender_name||'Defensor';
    const atkAv=document.getElementById('pvpAttackerAvatar'),defAv=document.getElementById('pvpDefenderAvatar');
    atkAv.src=data.attacker_avatar||playerData?.avatar_url||DEFAULT_AVATAR;defAv.src=data.defender_avatar||DEFAULT_AVATAR;
    atkAv.onerror=()=>{atkAv.src=DEFAULT_AVATAR;};defAv.onerror=()=>{defAv.src=DEFAULT_AVATAR;};
    const atkFill=document.getElementById('pvpAttackerHpFill'),defFill=document.getElementById('pvpDefenderHpFill');
    const atkTxt=document.getElementById('pvpAttackerHpText'),defTxt=document.getElementById('pvpDefenderHpText');
    const atkSide=document.getElementById('pvpAttackerSide'),defSide=document.getElementById('pvpDefenderSide');
    const cntdn=document.getElementById('pvpCountdown');
    const atkId=combat.attacker_id,defId=combat.defender_id;
    const dmgToDef=log.filter(t=>t.attacker_id===atkId).reduce((s,t)=>s+(t.damage||0),0);
    const dmgToAtk=log.filter(t=>t.attacker_id===defId).reduce((s,t)=>s+(t.damage||0),0);
    const defMaxHp=Math.max(1,(combat.defender_health_left||0)+dmgToDef);
    const atkMaxHp=Math.max(1,(combat.attacker_health_left||0)+dmgToAtk);
    let curAtk=atkMaxHp,curDef=defMaxHp;
    function updBars(){
        atkFill.style.width=Math.max(0,curAtk/atkMaxHp*100)+'%';
        defFill.style.width=Math.max(0,curDef/defMaxHp*100)+'%';
        atkTxt.textContent=Math.max(0,curAtk)+'/'+atkMaxHp;
        defTxt.textContent=Math.max(0,curDef)+'/'+defMaxHp;
    }
    updBars();modal.style.display='flex';cntdn.style.display='block';
    // M√∫sica de combate (estilo mina)
    try{if(audioCtx.state==='suspended')audioCtx.resume();}catch{}
    if(pvpBgMusic){pvpBgMusic.currentTime=0;pvpBgMusic.volume=0.12;pvpBgMusic.play().catch(()=>{});}
    for(let i=3;i>0;i--){cntdn.textContent='A batalha come√ßa em '+i+'...';await new Promise(r=>setTimeout(r,1000));}
    cntdn.style.display='none';
    for(const turn of log){
        const isAtk=turn.attacker_id===atkId;
        const tgtSide=isAtk?defSide:atkSide,tgtAv=isAtk?defAv:atkAv;
        if(isAtk)curDef=Math.max(0,curDef-(turn.damage||0));
        else curAtk=Math.max(0,curAtk-(turn.damage||0));
        updBars();
        _showDmgOnSide(turn.damage,turn.critical,turn.evaded,tgtSide);
        if(turn.evaded)playSound('evade');
        else if(turn.critical)playSound('critical');
        else playSound('normal');
        tgtAv.classList.remove('shake-animation');void tgtAv.offsetWidth;tgtAv.classList.add('shake-animation');
        setTimeout(()=>tgtAv.classList.remove('shake-animation'),400);
        await new Promise(r=>setTimeout(r,1000));
    }
    await new Promise(r=>setTimeout(r,600));
    if(pvpBgMusic){pvpBgMusic.pause();pvpBgMusic.currentTime=0;}
    modal.style.display='none';
    if(combat.winner_id===userId)await showAlert('‚öîÔ∏è <strong>VIT√ìRIA!</strong><br>'+esc(data.defender_name)+' foi eliminado!');
    else await showAlert('‚öîÔ∏è <strong>DERROTA.</strong><br>'+esc(data.defender_name)+' sobreviveu!');
}
function _showDmgOnSide(dmg,crit,evaded,sideEl){
    const el=document.createElement('div');
    if(evaded){el.textContent='Desviou';el.className='evade-text';}
    else{el.textContent=Number(dmg).toLocaleString();el.className=crit?'crit-damage-number':'damage-number';}
    sideEl.style.position='relative';
    sideEl.appendChild(el);
    el.addEventListener('animationend',()=>el.remove(),{once:true});
}

// ‚îÄ‚îÄ MODAL DE RECOMPENSAS ‚Äî agrupa por regi√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showRewardsModal(data){
    const modal=document.getElementById('rewardsModal'),content=document.getElementById('rewardsContent');
    const rewards=data.rewards||[]; // [{region_id, item_id, quantity}]
    const xpGained=data.xp_gained||0;

    // Agrupa por regi√£o
    const byRegion={};
    rewards.forEach(r=>{if(!byRegion[r.region_id])byRegion[r.region_id]=[];byRegion[r.region_id].push(r);});

    let html=`<div class="reward-xp-row"><span>‚ú® XP Total Ganho:</span><strong>+${xpGained}</strong></div>`;

    if(Object.keys(byRegion).length===0){
        html+='<p style="color:#aab;font-size:.82em;">Nenhuma recompensa (tempo insuficiente em qualquer regi√£o).</p>';
    } else {
        Object.entries(byRegion).forEach(([rid,items])=>{
            const regionName=ALL_REGIONS[rid]?.name||rid;
            html+=`<div class="region-rewards-block"><div class="region-rewards-title">üìç ${esc(regionName)}</div>`;
            items.forEach(g=>{
                const drop=ALL_DROPS[g.item_id];
                const img=drop?.img||DEFAULT_AVATAR;
                const name=drop?.name||`Item #${g.item_id}`;
                html+=`<div class="reward-item-row"><img src="${img}" alt="${esc(name)}" onerror="this.src='${DEFAULT_AVATAR}'"><div class="reward-item-info"><div class="reward-item-name">${esc(name)}</div><div class="reward-item-qty">x${g.quantity}</div></div></div>`;
            });
            html+='</div>';
        });
    }

    content.innerHTML=html;modal.style.display='flex';
    if(currentSession)currentSession.rewards_claimed=true;
    clearActivity();
    updateHuntingHUD();
}

// ‚îÄ‚îÄ BANNERS GLOBAIS DE PVP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncGlobalPvpEvents(){
    if(!userId)return;
    try{
        const{data,error}=await supabase.rpc('get_hunt_pvp_events',{p_since_minutes:5});
        if(error||!data)return;
        const seenKey=`hunt_pvp_seen_${userId}`;
        let seen;
        try{seen=new Set(JSON.parse(localStorage.getItem(seenKey)||'[]'));}catch{seen=new Set();}
        let changed=false;
        (data||[]).forEach(ev=>{
            if(seen.has(ev.id))return;
            seen.add(ev.id);changed=true;
            const regionLabel=`<span style="color:#8ff">${esc(ev.region_name)}</span>`;
            if(ev.attacker_won){
                const kTxt=ev.attacker_kills>0?`, eliminando um total de <span style="color:#ff8">${ev.attacker_kills}</span> hoje!`:'!';
                pushKillNotif(
                    `<span style="color:#ff8">${esc(ev.attacker_name)}</span> acabou de eliminar `+
                    `<span style="color:#f88">${esc(ev.defender_name)}</span> em `+
                    `${regionLabel}${kTxt}`
                );
            } else {
                const dkTxt=ev.defender_kills>0
                    ?`. <span style="color:#8ff">${esc(ev.defender_name)}</span> j√° eliminou <span style="color:#ff8">${ev.defender_kills}</span> hoje!`
                    :'.';
                pushKillNotif(
                    `<span style="color:#f88">${esc(ev.attacker_name)}</span> tentou atacar `+
                    `<span style="color:#ff8">${esc(ev.defender_name)}</span> em `+
                    `${regionLabel} e perdeu${dkTxt}`
                );
            }
        });
        if(changed){
            // Mant√©m apenas os √∫ltimos 200 IDs para n√£o inflar o localStorage
            const arr=[...seen].slice(-200);
            try{localStorage.setItem(seenKey,JSON.stringify(arr));}catch{}
        }
    }catch(e){console.warn('[floresta] pvp events error',e);}
}

// ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncOtherPlayers(){
    if(!userId)return;
    try{
        const{data,error}=await supabase.rpc('get_hunting_players',{p_player_id:userId,p_region_id:REGION_ID});
        if(error||!data)return;
        const newPlayers=data.players||[];

        // Detecta jogadores que sa√≠ram do spot (estado local) ‚Äî sem banner, o global j√° cobre
        otherPlayers.forEach(old=>{
            if(old.is_eliminated)return;
            const stillHere=newPlayers.find(np=>np.id===old.id);
            if(!stillHere&&old.is_hunting){
                pushKillNotif(`<span style="color:#ff8">${esc(old.name)}</span> deixou o spot em <span style="color:#8ff">${esc(REGION_NAME)}</span>.`);
            }
        });
        otherPlayers=newPlayers;renderOtherPlayers(otherPlayers);

        if(data.i_was_eliminated){
            if(isHunting){isHunting=false;stopLocalTimer();removePlayerFromSpot();updateHuntingHUD();}
            currentSpotId=null;
            document.getElementById('eliminatedByName').textContent=data.eliminated_by||'algu√©m';
            document.getElementById('eliminatedModal').style.display='flex';
        }
    }catch(e){console.warn('[floresta] sync error',e);}
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function boot(){
    showLoading();
    createKillBannerUI();
    try{
        userId=await getUserId();if(!userId){location.href='index.html';return;}
        playerData=await getPlayerData();
        preload('normal');preload('critical');preload('evade');
        await initShieldFromCache();

        // Restaura dead state se o player recarregou enquanto morto
        const savedAct=getActivity();
        if(savedAct?.pvp_dead&&savedAct?.dead_until&&savedAct.dead_until>Date.now()){
            deadUntil=savedAct.dead_until;
            const remaining=deadUntil-Date.now();
            clearTimeout(deadTimer);
            deadTimer=setTimeout(()=>{
                deadUntil=null;if(currentSpotId){isHunting=false;stopLocalTimer();removePlayerFromSpot();currentSpotId=null;}
                clearActivity();updateHuntingHUD();
            },remaining);
            // Restaura overlay de penalidade
            _startDeadOverlay();
        }
        // Lazy cleanup
        (async()=>{try{await supabase.rpc('cleanup_old_hunting_sessions');}catch{}})();
        renderSpots();

        // 1 RPC de boot ‚Äî retorna estado global + progresso nesta regi√£o
        const{data,error}=await supabase.rpc('get_hunting_state',{p_player_id:userId,p_region_id:REGION_ID});
        if(error)throw error;

        currentSession=data?.own_session||null;
        otherPlayers=data?.other_players||[];

        if(currentSession){
            const srvTotal=currentSession.total_seconds||0;
            let localTotal=srvTotal;
            // Projeta tempo decorrido offline se estava ca√ßando NESTA regi√£o
            if(currentSession.is_hunting&&currentSession.hunt_started_at&&currentSession.current_region===REGION_ID){
                const elapsed=Math.floor((Date.now()-new Date(currentSession.hunt_started_at).getTime())/1000);
                localTotal=Math.min(DAILY_LIMIT,srvTotal+elapsed);
            }
            localSecondsLeft=Math.max(0,DAILY_LIMIT-localTotal);
            // Spot ativo s√≥ se for DESTA regi√£o e n√£o estiver eliminado
            currentSpotId=(currentSession.current_region===REGION_ID)?currentSession.current_spot:null;
            if(currentSession.is_eliminated)currentSpotId=null; // garante que pode re-entrar no spot
            isHunting=currentSession.is_hunting
                &&currentSession.current_region===REGION_ID
                &&localSecondsLeft>0
                &&!currentSession.is_eliminated
                &&!currentSession.rewards_claimed;

            if(currentSession.shield_until){shieldUntil=new Date(currentSession.shield_until);if(isShieldActive())startShieldTimer();}
            if(isHunting&&currentSpotId){renderPlayerOnSpot(currentSpotId);startLocalTimer();amb.play().catch(()=>{});setActivityHunting(currentSpotId);}

            // Timer zerou offline
            if(localSecondsLeft<=0&&!currentSession.rewards_claimed&&srvTotal>=DAILY_LIMIT){isHunting=false;await onHuntComplete();}
            if(currentSession.is_eliminated){
                // Modal de elimina√ß√£o no boot
                document.getElementById('eliminatedByName').textContent=currentSession.eliminated_by_name||'um inimigo';
                document.getElementById('eliminatedModal').style.display='flex';
            }
        }

        updateHuntingHUD();renderOtherPlayers(otherPlayers);

        // Banners globais de PvP (inclui eventos recentes do boot)
        await syncGlobalPvpEvents();

        syncInterval=setInterval(()=>{syncOtherPlayers();syncGlobalPvpEvents();},SYNC_MS);
    }catch(e){console.error('[floresta] boot error',e);await showAlert('Erro ao carregar. Recarregue a p√°gina.');}
    finally{hideLoading();}
}

// ‚îÄ‚îÄ DOM READY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',async()=>{
    enableMapInteraction();
    document.getElementById('pauseHuntBtn').addEventListener('click',handlePauseHunt);
    document.getElementById('activateShieldBtn').addEventListener('click',handleActivateShield);
    document.getElementById('tutorialBtn').addEventListener('click',()=>{document.getElementById('huntInfoModal').style.display='flex';});
    document.getElementById('huntInfoClose').addEventListener('click',()=>{document.getElementById('huntInfoModal').style.display='none';});
    document.getElementById('huntInfoModal').addEventListener('click',e=>{if(e.target===document.getElementById('huntInfoModal'))document.getElementById('huntInfoModal').style.display='none';});
    document.getElementById('eliminatedCloseBtn').addEventListener('click',()=>{
        document.getElementById('eliminatedModal').style.display='none';
        currentSpotId=null; // permite entrar no mesmo spot em que foi morto
        removePlayerFromSpot();
        updateHuntingHUD();
    });
    document.getElementById('rewardsCloseBtn').addEventListener('click',()=>{document.getElementById('rewardsModal').style.display='none';});
    await boot();
});
</script>

<div id="google_translate_element"></div>
<script src="auto_translate.js"></script>
<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>
</html>
