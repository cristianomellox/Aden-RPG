<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" 
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <title>Mitrar - Aden RPG</title> 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="maintenance.js"></script>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="zion.css" /> 

</head>
<style>
  /* 1. Esconde o banner principal e o wrapper 'skiptranslate' */
.goog-te-banner-frame.skiptranslate, 
.skiptranslate {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
}

body {
    top: 0px !important; 
    margin-top: 0px !important;
    position: static !important; 
}
.goog-te-balloon-frame {
    display: none !important;
    visibility: hidden !important;
}

.goog-te-gadget {
    display: none !important;
    height: 0 !important;
    overflow: hidden !important;
}

font > font {
    background-color: transparent !important;
    box-shadow: none !important;
    position: static !important;
}
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');

/* Estilos gerais (Baseado em style.css) */
body, p, span, div, button {
    font-family: 'Cinzel', serif;
}
h1, h2 {
    font-family: 'Cinzel', serif;
    color: #e0dccc;
    text-shadow: 2px 2px 4px #000;
    letter-spacing: 1.5px;
}
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0; /* Removido padding-bottom */
    background-color: #121212;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
}

/* TopBar (Baseado em style.css e guild.html) */
#playerTopBar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 50px;
    background-color: #333;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    z-index: 1000;
}
.top-bar-link {
    color: white;
    text-decoration: none;
    display: flex;
    align-items: center;
}
.top-bar-link svg {
    width: 30px;
    height: 30px;
}
#pageTitle {
    color: #4CAF50; /* Cor Original para √Årea Pac√≠fica */
    font-size: 1.2em;
    font-weight: bold;
    text-shadow: 1px 1px 2px #000;
}


/* 3. Estilos para o Mapa em Tela Cheia */
#mapContainer {
    position: fixed; /* Fixa no viewport */
    top: 0;
    left: 0;
    width: 100vw; 
    height: 100vh; 
    overflow: hidden;
    margin: 0;
    z-index: 1; /* Abaixo da TopBar e do Conte√∫do */
    box-shadow: none;
    background-color: #121212; 
}

#map {
    background-image: url('https://aden-rpg.pages.dev/assets/mitrar.webp'); /* Imagem de fundo do mapa mantida */
    background-size: contain;
    background-repeat: no-repeat;
    background-position: top left;
    width: 1500px; 
    height: 1700px; 
    position: absolute;
    cursor: grab;
    transform-origin: top left;
    transition: transform 0.05s linear;
    transform: scale(1.1); /* Escala inicial para visualiza√ß√£o em dispositivos m√≥veis */
}

/* Container do Conte√∫do Flutuante */
#contentOverlay {
    position: absolute; /* Posiciona sobre o mapa */
    top: 50px; /* Abaixo da TopBar */
    left: 0;
    width: 100%;
    min-height: 95vh; /* Ocupa o restante da tela */
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* Empurra o footer para baixo */
    align-items: center;
    z-index: 10; /* Acima do mapa */
    /* Permite que o mapa receba eventos de clique, exceto nos filhos */
    pointer-events: none; 
}

#zionContent {
    width: 95%;
    max-width: 600px;
    margin-top: 2px; 
    padding: 10px;
    box-sizing: border-box;
    text-align: center;
    background-color: rgba(18, 18, 18, 0.5); /* Fundo semi-transparente para legibilidade */
    border-radius: 8px;
    pointer-events: auto; 
  
}

#zionContent h2 {
    margin-top: -13px;
    margin-bottom: 5px;
    color: gold; 
    text-shadow: 2px 2px 6px black; /* Melhor contraste sobre o mapa */
}

/* 2. Guilda Regente (Estilo e Posi√ß√£o) */
#guildreg-container {
    color: #e0dccc; 
    font-weight: bold; 
    margin-top: -10px;
    margin-bottom: 10px;
    pointer-events: auto;
}
#guildreg {
    color: orange; 
    font-size: 1em;
    text-shadow: 1px 1px 3px black;
}

/* Rodap√© espec√≠fico da p√°gina e bot√£o */
#zionFooter {
    margin-top: auto; /* Empurra para o final do #contentOverlay */
    padding: 10px;
    pointer-events: auto;
    display: flex;
    justify-content: center;
    width: 100%;
}

/* Bot√£o Hist√≥ria (Baseado em style.css) */
.action-btn {
    background-image: url('https://aden-rpg.pages.dev/assets/botao.webp'); 
    background-repeat: no-repeat;
    background-position: center center; 
    background-size: cover;
    box-sizing: border-box;
    background-color: transparent;
    border: none;
    cursor: pointer;
    color: #e0dccc;
    font-weight: bold;
    padding: 15px 40px; 
    font-size: 1.2em;
    text-shadow: 1px 1px 2px #000;
}
.action-btn:hover {
    opacity: 0.9;
}

/* Estilos do Modal (Mantidos) */
.modal-container {
    display: none; 
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background-color: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: #2e2e2e;
    padding: 20px;
    border: 3px solid #c9a94a;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    position: relative;
    max-height: 90vh; 
    box-sizing: border-box;
    text-align: center;
}

.close-btn {
    color: #aaa;
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 30px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    z-index: 2001;
}

.close-btn:hover,
.close-btn:focus {
    color: #e0dccc;
    text-decoration: none;
}

#historyText {
    overflow-y: auto;
    max-height: 70vh;
    padding-right: 10px; 
    text-align: left;
    color: #ccc;
}

/* === ESTILOS DO SUBMENU (Adicionado estilo Solaris/Capital) === */
.footer-submenu {
    position: fixed;
    display: none; /* Hidden by default */
    flex-direction: column;
    gap: 5px;
    background-color: rgba(30, 30, 30, 0.95);
    border: 1px solid #555;
    border-radius: 8px;
    padding: 5px;
    z-index: 9998;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.4);
    min-width: 180px;
}

.footer-submenu-btn {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 10px;
    color: #e0dccc;
    text-decoration: none;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 0.9em;
    font-weight: bold;
    background: #1e1e1e; 
    border: 1px solid #555;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    transition: all 0.3s ease;
    white-space: nowrap;      
    box-sizing: border-box;
    cursor: pointer;
}

.footer-submenu-btn:hover {
    background-color: #333;
    border-color: gold;
    color: #fff;
}

.submenu-icon {
    width: 50px;
    height: 50px;
    object-fit: contain;
    border-radius: 4px;
    display: block;
}

/* === MODAL FULLSCREEN MERCANTES === */
#merchantsModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.1)), url('https://aden-rpg.pages.dev/assets/mercantes_mitrar.webp');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: 3000;
    flex-direction: column;
    justify-content: flex-end; /* Conte√∫do no fundo */
    align-items: center;
}

/* Footer dentro do Modal Mercantes */
#merchantsFooter {
    width: 100%;
    padding: 20px;
    display: flex;
    justify-content: center;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
}

/* ================================================================= */
/* === ESTILOS LOJA MESTRE DE PO√á√ïES =============================== */
/* ================================================================= */
#potionMasterModal {
    background-image: linear-gradient(
      rgba(0, 0, 30, 0.2),
      rgba(0, 0, 0, 0)
    ),
    url('https://aden-rpg.pages.dev/assets/mdp_mitrar.webp');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    align-items: flex-start; 
    padding-top: 0;
}

.potion-master-content {
    width: 100% !important;
    height: 100% !important;
    max-width: 100% !important;
    max-height: 100vh !important;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
    padding: 20px 10px;
}

.pm-title {
    color: gold;
    font-size: 1.6em;
    text-shadow: 2px 2px 4px #000;
    margin-top: 40px;
    margin-bottom: 20px;
    text-align: center;
    padding: 5px 5px;
    border-radius: 8px;
    border: 1px solid #555;
    width: 90%;
}

/* --- BARRA DE RECURSOS (BASE) --- */
#userResourcesDisplay {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    background-color: rgba(0, 0, 0, 0.5);
    border: 1px solid #c9a94a;
    border-radius: 8px;
    padding: 8px 5px;
    color: #e0dccc;
    font-size: 0.9em;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);

    /* --- ANIMA√á√ÉO IGUAL AOS CARDS --- */
    opacity: 0; /* Come√ßa invis√≠vel */
    animation: fadeCardIn 10s ease-out forwards;
}

.res-item-display {
    display: flex;
    align-items: center;
    gap: 5px;
}

.res-icon-display {
    width: 24px;
    height: 24px;
    object-fit: contain;
    filter: drop-shadow(1px 1px 2px black);
}
/* ------------------------------------- */

.potion-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    width: 100%;
    max-width: 1200px;
    padding-bottom: 600px; /* Espa√ßo para scroll */
    padding-top: 10px; /* Ajustado para dar espa√ßo a barra de recursos */
}

/* Anima√ß√£o de Fade In para os cards */
@keyframes fadeCardIn {
    0% {
        opacity: 0;
        transform: translateY(20px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

.potion-card {
    background: linear-gradient(180deg, #2a2a2aBF, #1a1a1aBF);
    border: 1px solid #c9a94a;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    
    /* Configura√ß√£o da Anima√ß√£o */
    opacity: 0; /* Come√ßa invis√≠vel */
    animation: fadeCardIn 10s ease-out forwards;
}

.potion-header {
    display: flex;
    align-items: center;
    width: 100%;
    margin-bottom: 10px;
    border-bottom: 1px solid #444;
    padding-bottom: 5px;
}

.potion-img {
    width: 64px;
    height: 64px;
    margin-right: 15px;
    border: 1px solid #555;
    border-radius: 4px;
    background: #000;
}

.potion-info h4 {
    margin: 0;
    color: #e0dccc;
    font-size: 1.1em;
    text-align: left;
}

.cost-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
    color: #ccc;
    margin-top: 5px;
}

.cost-icon {
    width: 40px;
    height: 40px;
    vertical-align: middle;
}

.pm-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    gap: 10px;
    margin-top: auto;
}

.pm-qty-selector {
    display: flex;
    align-items: center;
    background: #333;
    border-radius: 5px;
    padding: 2px;
}

.pm-qty-btn {
    width: 35px;
    height: 35px;
    font-size: 1.2em;
    background: #444;
    border: 1px solid #555;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
}
.pm-qty-btn:hover { background: #555; }

.pm-qty-val {
    width: 40px;
    text-align: center;
    font-weight: bold;
    color: white;
}

.total-price-display {
    font-size: 0.9em;
    color: orange;
    display: flex;
    align-items: center;
    gap: 5px;
    background: rgba(0,0,0,0.4);
    padding: 5px 10px;
    border-radius: 4px;
}

.pm-buy-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(145deg, #7a5c1c, #c9a94a);
    border: 1px solid #ffd700;
    color: #000;
    font-weight: bold;
    cursor: pointer;
    text-transform: uppercase;
    font-size: 1em;
    text-shadow: none;
    border-radius: 4px;
}
.pm-buy-btn:hover { filter: brightness(1.1); }
.pm-buy-btn:disabled { filter: grayscale(1); cursor: not-allowed; opacity: 0.7; }

/* Estilo para a mensagem flutuante */
#floatingMessage {
    display: none;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.9);
    color: #e0dccc;
    padding: 15px 25px;
    border-radius: 8px;
    z-index: 10000;
    font-size: 1.1em;
    border: 2px solid gold;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
}
</style>
<body>

    <div id="playerTopBar">
        <button id="menuToggleBtn" class="top-bar-link" style="background:none; border:none; cursor:pointer; color:inherit; padding:0;">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
</button>
       <div> <span id="pageTitle">√Årea Pac√≠fica</span></div>
        <img src="https://aden-rpg.pages.dev/assets/refresh.webp" alt="Recarregar" style="width:30px; height:30px;">
    </div>

    <div id="mapContainer">
        <div id="map">
            </div>
    </div>

    <div id="contentOverlay">
        
        <div id="zionContent">
            <h2>Mitrar</h2> 
            
           <p id="guildreg-container">
    Guilda Regente:<br>
    <span id="guildreg_mitrar">
        <img id="guild_flag_mitrar" src="" alt="Bandeira da Guilda" 
            style="width: 40px; height: 42px; margin-right: 5px; border-radius: 3px; vertical-align: middle; object-fit: cover; display: none;">
        <span id="guild_name_mitrar">Nenhuma.</span>
        </span>
</p>
        </div>

        <div id="zionFooter">
            <button id="mitrarMenuBtn" class="action-btn">Menu</button>
        </div>

    </div>

    <div id="mitrarSubmenu" class="footer-submenu">
        <div id="btnOpenHistory" class="footer-submenu-btn">
            <img src="https://aden-rpg.pages.dev/assets/sobre.webp" class="submenu-icon"> Hist√≥ria
        </div>
        <div id="btnOpenMerchantsModal" class="footer-submenu-btn">
            <img src="https://aden-rpg.pages.dev/assets/mercante.webp" class="submenu-icon"> Distrito Mercante
        </div>
    </div>
    
    <div id="merchantsModal">
        <span class="close-btn" id="closeMerchantsModal" style="color:white; top:20px; right:20px; font-size:40px;">&times;</span>
        
        <div id="merchantsFooter">
            <button id="shopsMenuBtn" class="action-btn" style="padding: 35px 40px;">Mercantes</button>
        </div>
    </div>

    <div id="shopsSubmenu" class="footer-submenu">
        <div class="footer-submenu-btn" id="btnPotionMaster">
            <img src="https://aden-rpg.pages.dev/assets/mdp.webp" class="submenu-icon" style="width: 80px; height: 80px;"> Mestre de Po√ß√µes
        </div>
        <div class="footer-submenu-btn" style="display:none;">
            <img src="https://aden-rpg.pages.dev/assets/ferreiro.webp" class="submenu-icon" style="width: 80px; height: 80px;"> Oficina
        </div>
        <div style="display: none;" class="footer-submenu-btn">
            <img src="https://aden-rpg.pages.dev/assets/escambo.webp" class="submenu-icon" style="width: 80px; height: 80px;"> Escambo
        </div>
    </div>
    
    <!-- Modal Mestre de Po√ß√µes -->
    <div id="potionMasterModal" class="modal-container" style="display:none; z-index: 3005;">
        <div class="modal-content potion-master-content">
            <span class="close-btn" id="closePotionMasterBtn">&times;</span>
            
            <h3 class="pm-title">Troque Fragmentos por Po√ß√µes</h3>

            <!-- Mostra Recursos do Jogador (Apenas os Base) -->
            <div id="userResourcesDisplay">
                <span style="width:100%; text-align:center; color:gold;">Voc√™ tem:</span>
                Carregando recursos...
            </div>
            
            <div id="potionShopGrid" class="potion-grid">
                <!-- Itens gerados via JS -->
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-container" style="display: none;">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Hist√≥ria de Mitrar</h2> <div id="historyText">
                <p>Mitrar √© a joia escondida e inexpugn√°vel dos An√µes do Gelo. Erguida s√©culos atr√°s dentro do cora√ß√£o das Montanhas G√©lidas de Razar, ela representa a resili√™ncia e a maestria em forja da ra√ßa. Enquanto o exterior da montanha √© dominado por nevascas e frio extremo, as profundezas de Mitrar s√£o aquecidas pelo calor das forjas r√∫nicas, alimentadas por um veio vulc√¢nico subterr√¢neo.</p>
                <p>A cidade foi fundada pelo cl√£ &quot;M√£o de Gelo&quot; (ou Gl√°cia Forja), um grupo de an√µes que priorizou o isolamento e o dom√≠nio sobre os metais mais raros e frios, como o &quot;Ferro Estelar&quot;. O objetivo original era criar uma fortaleza auto-suficiente e impenetr√°vel, onde a honra do cl√£ e o respeito aos ancestrais fossem a √∫nica lei.</p>
                <p>A economia de Mitrar gira em torno de sua inigual√°vel metalurgia de precis√£o e dos raros cristais de gelo m√°gico encontrados nas veias da montanha. Eles n√£o comercializam mat√©ria-prima, mas sim artefatos finais: armas, armaduras e engenhocas r√∫nicas de qualidade lend√°ria, que vendem por pre√ßos exorbitantes aos reinos da superf√≠cie, mantendo sempre o fluxo de mercadorias estritamente controlado para preservar seu isolamento.</p>
                <p>O governo √© um Grande Conselho de Anci√µes da Forja, composto pelos &quot;Mestres do Zinco&quot;, os an√µes mais velhos e experientes, que julgam quest√µes de honra e habilidade artesanal. Eles mant√™m uma guarda de elite, os Defensores de Cristal, dedicados a patrulhar as passagens geladas e garantir que a reclus√£o da cidade nunca seja quebrada por curiosos ou invasores.</p>
                </div>
        </div>
    </div>
    
    <!-- Elemento para mensagens flutuantes -->
    <div id="floatingMessage"></div>

<script>
  let musicStarted = false;
let backgroundMusic;

document.addEventListener("DOMContentLoaded", () => {
  backgroundMusic = new Audio("https://aden-rpg.pages.dev/assets/mitrar.mp3"); // M√∫sica mantida
  backgroundMusic.volume = 0.3;
  backgroundMusic.loop = true;

  function startBackgroundMusic() {
    if (musicStarted) return;
    backgroundMusic.play().then(() => {
      musicStarted = true;
      console.log("üéµ M√∫sica de fundo iniciada!");
    }).catch(err => console.warn("‚ö†Ô∏è Falha ao iniciar m√∫sica:", err));
  }

  // Fun√ß√£o utilit√°ria para registrar listeners com op√ß√µes comuns
  function addCapturedListener(target, evt, handler, opts = {}) {
    try {
      target.addEventListener(evt, handler, Object.assign({ capture: true, passive: true, once: false }, opts));
    } catch (e) {
      // alguns targets (ex: null) podem falhar, silenciosamente ignoramos
    }
  }

  // 1) Eventos prim√°rios que normalmente desbloqueiam √°udio
  const primaryEvents = ["click", "pointerdown", "touchstart", "mousedown", "keydown"];
  for (const ev of primaryEvents) {
    addCapturedListener(window, ev, function onPrimary(e) {
      startBackgroundMusic();
      // remover listener √© opcional; play() verifica musicStarted
    });
    addCapturedListener(document.body, ev, function onPrimary2(e) {
      startBackgroundMusic();
    });
  }

  // 2) Tentar capturar ARRASTO ‚Äî s√≥ inicia se houver um toque/pointer real associado
  let moveArmed = false; // armar√° o gatilho quando detectarmos um pointerdown/touchstart
  function armMove() { moveArmed = true; /* breve timeout para evitar ficar armado indefinidamente */ setTimeout(()=> moveArmed = false, 1200); }

  addCapturedListener(window, "pointerdown", armMove);
  addCapturedListener(window, "touchstart", armMove);
  addCapturedListener(document.body, "pointerdown", armMove);
  addCapturedListener(document.body, "touchstart", armMove);

  function handleMoveForMusic(e) {
    if (musicStarted || !moveArmed) return;
    // Verifica se o movimento tem dedos ou press√£o (sinal de arraste real)
    const isTouchMove = (e.touches && e.touches.length > 0);
    const hasPressure = (e.pressure && e.pressure > 0) || (e.buttons && e.buttons > 0);
    if (isTouchMove || hasPressure || e.pointerType) {
      startBackgroundMusic();
      moveArmed = false;
    }
  }
  addCapturedListener(window, "touchmove", handleMoveForMusic);
  addCapturedListener(window, "pointermove", handleMoveForMusic);
  addCapturedListener(document.body, "touchmove", handleMoveForMusic);
  addCapturedListener(document.body, "pointermove", handleMoveForMusic);

  // 3) Especial: anexa listeners diretamente aos elementos de mapa mais comuns
  // Busca por ids/classes que costumam ser usadas por mapas (ajuste se seu mapa usa outro seletor)
  const mapSelectors = [
    "#mapContainer",
    "#map",
    ".map",
    ".leaflet-container",
    ".mapboxgl-canvas",
    ".mapboxgl-map"
  ];
  for (const sel of mapSelectors) {
    document.querySelectorAll(sel).forEach(el => {
      addCapturedListener(el, "pointerdown", () => { startBackgroundMusic(); armMove(); });
      addCapturedListener(el, "touchstart", () => { startBackgroundMusic(); armMove(); });
      addCapturedListener(el, "touchmove", handleMoveForMusic);
      addCapturedListener(el, "pointermove", handleMoveForMusic);
    });
  }

  // 4) Fallbacks adicionais: se usu√°rio soltar (pointerup / touchend) ap√≥s arrastar, tente tocar
  function tryOnUp(e) { if (!musicStarted) startBackgroundMusic(); }
  addCapturedListener(window, "pointerup", tryOnUp);
  addCapturedListener(window, "touchend", tryOnUp);
  addCapturedListener(document.body, "pointerup", tryOnUp);
  addCapturedListener(document.body, "touchend", tryOnUp);

  // 5) Fallback temporizado (ap√≥s pequena intera√ß√£o) ‚Äî evita tentar tocar muitas vezes
  setTimeout(() => {
    if (!musicStarted) {
      // √∫ltima tentativa silenciosa
      try { startBackgroundMusic(); } catch(e) {}
    }
  }, 6000);

  // Expor para debug / chamadas manuais
  window.startBackgroundMusic = startBackgroundMusic;
  window.__musicDebug = { isStarted: () => musicStarted };
});
// FIM DA M√öSICA DE FUNDO
  
function enableMapInteraction() {
    const mapContainer = document.getElementById('mapContainer');
    const map = document.getElementById('map');
    if (!map || !mapContainer) return;

    let isDragging = false;
    let startX, startY;
    let currentX = 0;
    let currentY = 0;
    let velocityX = 0;
    let velocityY = 0;
    let lastMoveTime = 0;

    // Calcula os limites de movimento do mapa
    function recalcLimits() {
        const containerRect = mapContainer.getBoundingClientRect();
        
        // Fator de escala atual
        const style = window.getComputedStyle(map);
        const transformMatrix = style.getPropertyValue('transform');
        let scaleX = 1;

        if (transformMatrix && transformMatrix !== 'none') {
            const matrix = transformMatrix.match(/matrix.*\((.+)\)/);
            if(matrix && matrix[1]) {
                scaleX = parseFloat(matrix[1].split(', ')[0]);
            }
        } else {
             const initialTransform = map.style.transform;
             const scaleMatch = initialTransform.match(/scale\(([^)]+)\)/);
             if (scaleMatch) {
                 scaleX = parseFloat(scaleMatch[1]);
             }
        }
        
        const mapNaturalWidth = 1500; // Largura da imagem original em px (style.css)
        const mapNaturalHeight = 1500; // Altura da imagem original em px (style.css)
        
        // Tamanho atual do mapa escalado
        const scaledMapWidth = mapNaturalWidth * scaleX;
        const scaledMapHeight = mapNaturalHeight * scaleX;

        // Limites de deslocamento (X/Y)
        const maxMoveX = 0;
        const minMoveX = containerRect.width - scaledMapWidth;
        const maxMoveY = 0;
        const minMoveY = containerRect.height - scaledMapHeight;
        
        return {
            minX: Math.min(maxMoveX, minMoveX),
            maxX: Math.max(maxMoveX, minMoveX),
            minY: Math.min(maxMoveY, minMoveY),
            maxY: Math.max(maxMoveY, minMoveY)
        };
    }

    // Aplica a transforma√ß√£o do mapa, respeitando os limites
    function setMapPosition(x, y) {
        const limits = recalcLimits();
        currentX = Math.max(limits.minX, Math.min(x, limits.maxX));
        currentY = Math.max(limits.minY, Math.min(y, limits.maxY));
        
        const style = window.getComputedStyle(map);
        const transformMatrix = style.getPropertyValue('transform');
        let scale = 'scale(1.1)';

        if (transformMatrix && transformMatrix !== 'none') {
            const match = transformMatrix.match(/scale\(([^)]+)\)/);
            if (match) {
                scale = `scale(${match[1]})`;
            }
        } else if (map.style.transform) {
             const match = map.style.transform.match(/scale\(([^)]+)\)/);
             if (match) {
                scale = `scale(${match[1]})`;
            }
        }
        
        map.style.transform = `translate(${currentX}px, ${currentY}px) ${scale}`;
    }

    // Anima√ß√£o de in√©rcia (movimento p√≥s-arrasto)
    let animationFrameId = null;
    function inertiaAnimation() {
        cancelAnimationFrame(animationFrameId);

        if (isDragging) {
            velocityX = 0;
            velocityY = 0;
            return;
        }

        // Reduz a velocidade (fric√ß√£o)
        velocityX *= 0.95; 
        velocityY *= 0.95;

        // Aplica o movimento
        setMapPosition(currentX + velocityX, currentY + velocityY);

        // Se a velocidade for muito baixa, para a in√©rcia
        if (Math.abs(velocityX) > 0.5 || Math.abs(velocityY) > 0.5) {
            animationFrameId = requestAnimationFrame(inertiaAnimation);
        } else {
            velocityX = 0;
            velocityY = 0;
        }
    }

    // In√≠cio do arrasto
    function startDrag(e) {
        if (e.touches && e.touches.length > 1) return;

        isDragging = true;
        map.style.cursor = 'grabbing';
        
        // Coordenadas de in√≠cio (considera toque ou mouse)
        startX = e.clientX || e.touches[0].clientX;
        startY = e.clientY || e.touches[0].clientY;
        
        velocityX = 0;
        velocityY = 0;
        lastMoveTime = performance.now();
        cancelAnimationFrame(animationFrameId); 
    }

    // Durante o arrasto
    function onDrag(e) {
        if (!isDragging) return;
        
        e.preventDefault(); 
        
        const newX = e.clientX || e.touches[0].clientX;
        const newY = e.clientY || e.touches[0].clientY;
        const dx = newX - startX;
        const dy = newY - startY;

        // Calcula a velocidade para a in√©rcia
        const currentTime = performance.now();
        const deltaTime = currentTime - lastMoveTime;

        if (deltaTime > 0) {
            velocityX = dx / deltaTime;
            velocityY = dy / deltaTime;
        }
        
        setMapPosition(currentX + dx, currentY + dy);

        // Atualiza as posi√ß√µes de in√≠cio para o pr√≥ximo movimento
        startX = newX;
        startY = newY;
        lastMoveTime = currentTime;
    }

    // Fim do arrasto
    function endDrag() {
        isDragging = false;
        map.style.cursor = 'grab';
        
        if (Math.abs(velocityX) > 0.2 || Math.abs(velocityY) > 0.2) {
            // Multiplicamos a velocidade para dar um "empurr√£o" de in√©rcia
            velocityX *= 10; 
            velocityY *= 10;
            inertiaAnimation();
        } else {
            velocityX = 0;
            velocityY = 0;
        }
    }

    // Adiciona os event listeners
    map.addEventListener('mousedown', startDrag, { passive: true });
    window.addEventListener('mousemove', onDrag, { passive: false });
    window.addEventListener('mouseup', endDrag, { passive: true });

    map.addEventListener('touchstart', startDrag, { passive: true });
    window.addEventListener('touchmove', onDrag, { passive: false });
    window.addEventListener('touchend', endDrag, { passive: true });

    map.style.cursor = 'grab';

    // Garante que os limites sejam calculados no carregamento
    setTimeout(() => {
        recalcLimits();
        // Opcional: Centralizar o mapa inicialmente
        // setMapPosition(limits.minX / 2, limits.minY / 2);
    }, 100);
}

// =======================================================================
// L√≥gica de UI (Menus, Submenus e Modais) - ATUALIZADO PARA MITRAR
// =======================================================================
document.addEventListener('DOMContentLoaded', () => {
    
    // --- 1. Menu Principal de Mitrar ---
    const menuBtn = document.getElementById('mitrarMenuBtn');
    const submenu = document.getElementById('mitrarSubmenu');

    if (menuBtn && submenu) {
        menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = submenu.style.display === 'flex';
            if (!isVisible) {
                submenu.style.display = 'flex';
                // Posiciona acima do bot√£o Menu
                const btnRect = menuBtn.getBoundingClientRect();
                const submenuRect = submenu.getBoundingClientRect();
                let newLeft = (btnRect.left + (btnRect.width / 2) - (submenuRect.width / 2));
                let newTop = btnRect.top - submenuRect.height - 10; 
                submenu.style.top = newTop + 'px';
                submenu.style.left = newLeft + 'px';
            } else {
                submenu.style.display = 'none';
            }
        });
    }

    // --- 2. Modal de Hist√≥ria ---
    // Gatilho agora √© o bot√£o dentro do submenu
    const openHistoryBtn = document.getElementById('btnOpenHistory');
    const historyModal = document.getElementById('historyModal');
    const closeHistoryBtn = historyModal.querySelector('.close-btn');

    if (openHistoryBtn && historyModal) {
        openHistoryBtn.addEventListener('click', () => {
            historyModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            if(submenu) submenu.style.display = 'none'; // Fecha o submenu
        });

        closeHistoryBtn.addEventListener('click', () => {
            historyModal.style.display = 'none';
            document.body.style.overflow = '';
        });
        
        // Fecha ao clicar fora
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) {
                historyModal.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
    }

    // --- 3. Modal de Mercantes (Tela Cheia) ---
    const openMerchantsBtn = document.getElementById('btnOpenMerchantsModal');
    const merchantsModal = document.getElementById('merchantsModal');
    const closeMerchantsBtn = document.getElementById('closeMerchantsModal');

    if (openMerchantsBtn && merchantsModal) {
        openMerchantsBtn.addEventListener('click', () => {
            merchantsModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            if(submenu) submenu.style.display = 'none'; // Fecha o submenu principal
        });

        closeMerchantsBtn.addEventListener('click', () => {
            merchantsModal.style.display = 'none';
            document.body.style.overflow = '';
            // Se houver submenu de lojas aberto, fecha tamb√©m
            const shopsSubmenu = document.getElementById('shopsSubmenu');
            if(shopsSubmenu) shopsSubmenu.style.display = 'none';
        });
    }

    // --- 4. Submenu de Lojas (Dentro do Modal Mercantes) ---
    const shopsMenuBtn = document.getElementById('shopsMenuBtn');
    const shopsSubmenu = document.getElementById('shopsSubmenu');

    if (shopsMenuBtn && shopsSubmenu) {
        shopsMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = shopsSubmenu.style.display === 'flex';
            
            if (!isVisible) {
                shopsSubmenu.style.display = 'flex';
                // Calcula posi√ß√£o baseado no bot√£o dentro do modal
                const btnRect = shopsMenuBtn.getBoundingClientRect();
                const submenuRect = shopsSubmenu.getBoundingClientRect();
                
                let newLeft = (btnRect.left + (btnRect.width / 2) - (submenuRect.width / 2));
                let newTop = btnRect.top - submenuRect.height - 10;
                
                // Aplica z-index alto para ficar acima do modal fullscreen
                shopsSubmenu.style.zIndex = '3002'; 
                shopsSubmenu.style.top = newTop + 'px';
                shopsSubmenu.style.left = newLeft + 'px';
            } else {
                shopsSubmenu.style.display = 'none';
            }
        });
    }

    // Listener global para fechar submenus ao clicar fora
    document.addEventListener('click', (e) => {
        // Fechar submenu principal
        if (submenu && submenu.style.display === 'flex') {
            if (!e.target.closest('#mitrarSubmenu') && !e.target.closest('#mitrarMenuBtn')) {
                submenu.style.display = 'none';
            }
        }
        // Fechar submenu de lojas
        if (shopsSubmenu && shopsSubmenu.style.display === 'flex') {
            if (!e.target.closest('#shopsSubmenu') && !e.target.closest('#shopsMenuBtn')) {
                shopsSubmenu.style.display = 'none';
            }
        }
    });

    // Habilita o mapa arrast√°vel ap√≥s o carregamento da p√°gina
    enableMapInteraction();
});
</script>

<script type="module">
  import { supabase } from './supabaseClient.js'


// --- HELPER DE AUTH OTIMISTA (ZERO EGRESS) ---
function getLocalUserId() {
    try {
        const cached = localStorage.getItem('player_data_cache');
        if (cached) {
            const parsed = JSON.parse(cached);
            if (parsed && parsed.data && parsed.data.id && (parsed.expires > Date.now() || !parsed.expires)) {
                return parsed.data.id;
            }
        }
    } catch (e) {}

    try {
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (k.startsWith('sb-') && k.endsWith('-auth-token')) {
                const sessionStr = localStorage.getItem(k);
                const session = JSON.parse(sessionStr);
                if (session && session.user && session.user.id) {
                    return session.user.id;
                }
            }
        }
    } catch (e) {}

    return null;
}

async function fetchAndDisplayCityOwner(cityName) {
    const cityNameLower = cityName.toLowerCase();
    const cacheKey = `city_owner_cache_${cityNameLower}`;
    
    // IDs dos elementos DOM
    const nameSpan = document.getElementById(`guild_name_${cityNameLower}`);
    const flagImg = document.getElementById(`guild_flag_${cityNameLower}`);
    const defaultText = 'Nenhuma.';

    if (!nameSpan || !flagImg) {
        console.error(`Elementos de guilda para ${cityName} n√£o encontrados.`);
        return;
    }

    const updateUI = (name, flagUrl) => {
        if (name && flagUrl) {
            flagImg.setAttribute('src', flagUrl);
            flagImg.style.display = 'inline-block';
            flagImg.setAttribute('alt', `Bandeira da Guilda ${name}`);
            nameSpan.textContent = name;
        } else {
            flagImg.style.display = 'none';
            nameSpan.textContent = defaultText;
        }
    };

    try {
        const cachedRaw = localStorage.getItem(cacheKey);
        if (cachedRaw) {
            const cached = JSON.parse(cachedRaw);
            const now = new Date().getTime();
            if (cached && cached.expiry && now < cached.expiry) {
                console.log(`[Cache] Carregando dono de ${cityName} do cache local.`);
                updateUI(cached.guildName, cached.guildFlag);
                return;
            }
        }
    } catch (e) {
        console.warn("Erro ao ler cache da cidade:", e);
    }

    try {
        console.log(`[Network] Buscando dono de ${cityName} no Supabase...`);
        const { data: ownersData, error } = await supabase.rpc('get_city_owners');

        if (error) {
            console.error('Erro Supabase ao buscar donos das cidades:', error);
            return;
        }

        const cityOwnerData = ownersData?.find(city => city.city_name.toLowerCase() === cityNameLower);
        
        let guildName = null;
        let guildFlag = null;

        if (cityOwnerData && cityOwnerData.owner_guild_id) {
            guildName = cityOwnerData.owner_guild_name || 'Guilda Desconhecida';
            guildFlag = cityOwnerData.owner_guild_flag || 'https://aden-rpg.pages.dev/assets/guildaflag.webp';
        }

        updateUI(guildName, guildFlag);

        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setUTCDate(now.getUTCDate() + 1);
        tomorrow.setUTCHours(0, 0, 0, 0);
        
        const expiryTimestamp = tomorrow.getTime();

        const cacheData = {
            guildName: guildName,
            guildFlag: guildFlag,
            expiry: expiryTimestamp
        };

        localStorage.setItem(cacheKey, JSON.stringify(cacheData));

    } catch (err) {
        console.error('Erro inesperado na fun√ß√£o fetchAndDisplayCityOwner:', err);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const pageTitle = document.title;
    const cityNames = ['Astrax', 'Capital', 'Duratar', 'Elendor', 'Mitrar', 'Tandra', 'Zion'];
    const cityName = cityNames.find(c => pageTitle.toLowerCase().includes(c.toLowerCase()));

    if (cityName) {
        fetchAndDisplayCityOwner(cityName);
    } else {
        console.warn('N√£o foi poss√≠vel determinar o nome da cidade a partir do t√≠tulo.');
    }
});


/* ================================================================= */
/* === L√ìGICA MESTRE DE PO√á√ïES (MITRAR) ============================ */
/* ================================================================= */

// Lista de Receitas do Mestre de Po√ß√µes de MITRAR
const potionRecipes = [
    // --- RANK R ---
    {
        id: 43, name: "Po√ß√£o de Cura R", 
        img: "https://aden-rpg.pages.dev/assets/itens/pocao_de_cura_r.webp",
        resId: 51, resName: "Elora", resCost: 10, resImg: "https://aden-rpg.pages.dev/assets/itens/elora.webp",
        fragId: 10, fragCost: 5, fragImg: "https://aden-rpg.pages.dev/assets/itens/fragmento_de_anel_runico.webp"
    },
    {
        id: 47, name: "Po√ß√£o de Destreza R", 
        img: "https://aden-rpg.pages.dev/assets/itens/pocao_de_destreza_r.webp",
        resId: 52, resName: "Lumina", resCost: 10, resImg: "https://aden-rpg.pages.dev/assets/itens/lumina.webp",
        fragId: 12, fragCost: 5, fragImg: "https://aden-rpg.pages.dev/assets/itens/fragmento_de_armadura_de_bronze.webp"
    },
    {
        id: 45, name: "Po√ß√£o de F√∫ria R", 
        img: "https://aden-rpg.pages.dev/assets/itens/pocao_de_furia_r.webp", 
        resId: 53, resName: "Rutus", resCost: 10, resImg: "https://aden-rpg.pages.dev/assets/itens/rutus.webp",
        fragId: 16, fragCost: 5, fragImg: "https://aden-rpg.pages.dev/assets/itens/fragmento_de_elmo_de_bronze.webp"
    },
    {
        id: 49, name: "Po√ß√£o de Ataque R", 
        img: "https://aden-rpg.pages.dev/assets/itens/pocao_de_ataque_r.webp", 
        resId: 54, resName: "Galdra", resCost: 10, resImg: "https://aden-rpg.pages.dev/assets/itens/galdra.webp",
        fragId: 18, fragCost: 5, fragImg: "https://aden-rpg.pages.dev/assets/itens/fragmento_de_lagrima_da_sereia.webp"
    },
    // --- RANK SR ---
    {
        id: 44, name: "Po√ß√£o de Cura SR", 
        img: "https://aden-rpg.pages.dev/assets/itens/pocao_de_cura_sr.webp",
        resId: 51, resName: "Elora", resCost: 25, resImg: "https://aden-rpg.pages.dev/assets/itens/elora.webp",
        fragId: 32, fragCost: 5, fragImg: "https://aden-rpg.pages.dev/assets/itens/fragmento_de_anel_estelar.webp"
    },
    {
        id: 48, name: "Po√ß√£o de Destreza SR", 
        img: "https://aden-rpg.pages.dev/assets/itens/pocao_de_destreza_sr.webp",
        resId: 52, resName: "Lumina", resCost: 25, resImg: "https://aden-rpg.pages.dev/assets/itens/lumina.webp",
        fragId: 38, fragCost: 5, fragImg: "https://aden-rpg.pages.dev/assets/itens/fragmento_de_armadura_da_vitalidade.webp"
    },
    {
        id: 46, name: "Po√ß√£o de F√∫ria SR", 
        img: "https://aden-rpg.pages.dev/assets/itens/pocao_de_furia_sr.webp",
        resId: 53, resName: "Rutus", resCost: 25, resImg: "https://aden-rpg.pages.dev/assets/itens/rutus.webp",
        fragId: 36, fragCost: 5, fragImg: "https://aden-rpg.pages.dev/assets/itens/fragmento_de_protecao_feroz.webp"
    },
    {
        id: 50, name: "Po√ß√£o de Ataque SR", 
        img: "https://aden-rpg.pages.dev/assets/itens/pocao_de_ataque_sr.webp",
        resId: 54, resName: "Galdra", resCost: 25, resImg: "https://aden-rpg.pages.dev/assets/itens/galdra.webp",
        fragId: 34, fragCost: 5, fragImg: "https://aden-rpg.pages.dev/assets/itens/fragmento_de_amuleto_oculto.webp"
    }
];

const fmt = (num) => new Intl.NumberFormat('pt-BR').format(num);

// --- Carregar Recursos Base do Cache IDB ---
async function loadResourcesFromCache() {
    const DB_NAME = "aden_inventory_db";
    const STORE_NAME = "inventory_store";
    const DB_VERSION = 47; 

    const resourceMap = {
        51: { count: 0, name: 'Elora', img: 'https://aden-rpg.pages.dev/assets/itens/elora.webp' },
        52: { count: 0, name: 'Lumina', img: 'https://aden-rpg.pages.dev/assets/itens/lumina.webp' },
        53: { count: 0, name: 'Rutus', img: 'https://aden-rpg.pages.dev/assets/itens/rutus.webp' },
        54: { count: 0, name: 'Galdra', img: 'https://aden-rpg.pages.dev/assets/itens/galdra.webp' }
    };

    return new Promise((resolve) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => resolve(resourceMap); 

        req.onsuccess = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                resolve(resourceMap); return;
            }

            const tx = db.transaction(STORE_NAME, "readonly");
            const store = tx.objectStore(STORE_NAME);
            const getAllReq = store.getAll();

            getAllReq.onsuccess = () => {
                const items = getAllReq.result || [];
                items.forEach(invItem => {
                    const itemId = invItem.items?.item_id;
                    if (resourceMap[itemId]) {
                        resourceMap[itemId].count += (invItem.quantity || 0);
                    }
                });
                resolve(resourceMap);
            };
            getAllReq.onerror = () => resolve(resourceMap);
        };
    });
}

// Atualizar Cache Local (Com fix de String ID)
async function updateResourceCache(resId, resQty, fragId, fragQty) {
    const DB_NAME = "aden_inventory_db";
    const STORE_NAME = "inventory_store";
    const DB_VERSION = 47;

    return new Promise((resolve) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onsuccess = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) { resolve(); return; }
            
            const tx = db.transaction(STORE_NAME, "readwrite");
            const store = tx.objectStore(STORE_NAME);
            const getAll = store.getAll();

            getAll.onsuccess = () => {
                const items = getAll.result;
                const targets = [
                    { id: String(resId), qty: resQty },
                    { id: String(fragId), qty: fragQty }
                ];

                for (const item of items) {
                    if (!item.items || !item.items.item_id) continue;
                    
                    const currentId = String(item.items.item_id);
                    const targetIndex = targets.findIndex(t => t.id === currentId);
                    
                    if (targetIndex !== -1) {
                        const target = targets[targetIndex];
                        if (item.quantity >= target.qty) {
                            item.quantity -= target.qty;
                            target.qty = 0;
                            if (item.quantity <= 0) store.delete(item.id);
                            else store.put(item);
                        } else {
                            target.qty -= item.quantity;
                            store.delete(item.id);
                        }
                    }
                }
            };
            tx.oncomplete = () => resolve();
            tx.onerror = () => resolve(); 
        };
        req.onerror = () => resolve();
    });
}

// Renderiza a grade de itens
function renderPotionShop() {
    const grid = document.getElementById('potionShopGrid');
    if (!grid) return;
    grid.innerHTML = '';

    potionRecipes.forEach(item => {
        const card = document.createElement('div');
        card.className = 'potion-card';
        card.innerHTML = `
            <div class="potion-header">
                <img src="${item.img}" class="potion-img" alt="${item.name}">
                <div class="potion-info">
                    <h4>${item.name}</h4>
                    <div class="cost-row">
                        <img src="${item.resImg}" class="cost-icon" title="${item.resName}">
                        <span>x${item.resCost}</span>
                        <img src="${item.fragImg}" class="cost-icon" style="margin-left:5px;" title="Fragmento">
                        <span>x${item.fragCost}</span>
                    </div>
                </div>
            </div>
            
            <div class="pm-controls">
                <div class="pm-qty-selector">
                    <button class="pm-qty-btn minus" data-id="${item.id}">-</button>
                    <span class="pm-qty-val" id="qty-${item.id}">1</span>
                    <button class="pm-qty-btn plus" data-id="${item.id}">+</button>
                </div>
                
                <div class="total-price-display">
                    Total: 
                    <img src="${item.resImg}" class="cost-icon" style="width:16px;height:16px;">
                    <span id="tot-res-${item.id}">${item.resCost}</span> + 
                    <img src="${item.fragImg}" class="cost-icon" style="width:16px;height:16px;">
                    <span id="tot-frag-${item.id}">${item.fragCost}</span>
                </div>

                <button class="pm-buy-btn" id="buy-btn-${item.id}" data-id="${item.id}">Trocar</button>
            </div>
        `;
        grid.appendChild(card);
    });

    // Event Listeners
    document.querySelectorAll('.pm-qty-btn.plus').forEach(b => b.addEventListener('click', (e) => updateQty(e.target.closest('.pm-qty-btn').dataset.id, 1)));
    document.querySelectorAll('.pm-qty-btn.minus').forEach(b => b.addEventListener('click', (e) => updateQty(e.target.closest('.pm-qty-btn').dataset.id, -1)));
    document.querySelectorAll('.pm-buy-btn').forEach(b => b.addEventListener('click', (e) => buyPotion(e.target.dataset.id)));
}

// Atualiza quantidade e pre√ßo total na UI
function updateQty(id, delta) {
    id = parseInt(id);
    const qtySpan = document.getElementById(`qty-${id}`);
    if(!qtySpan) return;

    let currentQty = parseInt(qtySpan.textContent);
    let newQty = currentQty + delta;
    if (newQty < 1) newQty = 1;
    if (newQty > 99) newQty = 99; 

    qtySpan.textContent = newQty;

    // Atualiza totais visuais
    const recipe = potionRecipes.find(r => r.id === id);
    if (recipe) {
        document.getElementById(`tot-res-${id}`).textContent = fmt(recipe.resCost * newQty);
        document.getElementById(`tot-frag-${id}`).textContent = fmt(recipe.fragCost * newQty);
    }
}

function showMsg(msg) {
    const floatDiv = document.getElementById('floatingMessage');
    if (floatDiv) {
        floatDiv.textContent = msg;
        floatDiv.style.display = 'block';
        floatDiv.style.opacity = '1';
        setTimeout(() => { floatDiv.style.opacity = '0'; setTimeout(()=>floatDiv.style.display='none', 500); }, 3000);
    } else {
        alert(msg);
    }
}

// Fun√ß√£o de Compra (Chama RPC Espec√≠fica de Mitrar)
async function buyPotion(id) {
    id = parseInt(id);
    const btn = document.getElementById(`buy-btn-${id}`);
    const qty = parseInt(document.getElementById(`qty-${id}`).textContent);
    const recipe = potionRecipes.find(r => r.id === id);

    if (!recipe) return;

    btn.disabled = true;
    btn.textContent = "Trocando...";

    try {
        // CHAMA A NOVA FUN√á√ÉO RPC PARA MITRAR
        const { data, error } = await supabase.rpc('exchange_potion_mitrar', {
            p_potion_id: id,
            p_quantity: qty
        });

        if (error) throw error;
        if (!data.success) throw new Error(data.message);

        showMsg(`Sucesso! Voc√™ recebeu ${qty}x ${recipe.name}.`);
        
        // Atualizar visualmente o Recurso Base
        const currentSpan = document.getElementById(`res-display-count-${recipe.resId}`);
        if(currentSpan) {
            let val = parseInt(currentSpan.textContent.replace('X','')) || 0;
            val = Math.max(0, val - (recipe.resCost * qty));
            currentSpan.textContent = `X${val}`;
        }
        
        // Atualizar IndexedDB para ambos os itens consumidos
        await updateResourceCache(recipe.resId, recipe.resCost * qty, recipe.fragId, recipe.fragCost * qty);

    } catch (err) {
        console.error(err);
        showMsg(`Erro: ${err.message || "Falha na troca."}`);
    } finally {
        if(btn) {
            btn.disabled = false;
            btn.textContent = "Trocar";
        }
    }
}

// Inicializa√ß√£o do Modal
document.addEventListener('DOMContentLoaded', () => {
    const openBtn = document.getElementById('btnPotionMaster');
    const modal = document.getElementById('potionMasterModal');
    const closeBtn = document.getElementById('closePotionMasterBtn');

    if (openBtn && modal) {
        openBtn.addEventListener('click', async () => {
            renderPotionShop();
            modal.style.display = 'flex';
            
            // --- Carrega Recursos (Somente Base) ---
            const resContainer = document.getElementById('userResourcesDisplay');
            if (resContainer) {
                resContainer.innerHTML = '<span style="width:100%; text-align:center; color:gold; margin-bottom:5px;">Voc√™ tem:</span> Carregando...';
                
                try {
                    const counts = await loadResourcesFromCache();
                    resContainer.innerHTML = '<span style="width:100%; text-align:center; color:gold; margin-bottom:5px;">Voc√™ tem:</span>';
                    
                    [51, 52, 53, 54].forEach(id => {
                        const data = counts[id];
                        const div = document.createElement('div');
                        div.className = 'res-item-display';
                        div.innerHTML = `
                            <img src="${data.img}" class="res-icon-display" alt="${data.name}">
                            <span style="font-weight:bold; color: #fff;" id="res-display-count-${id}">X${data.count}</span>
                        `;
                        resContainer.appendChild(div);
                    });
                } catch (e) {
                    resContainer.innerHTML = 'N√£o foi poss√≠vel carregar os recursos.';
                }
            }

            const shopsSub = document.getElementById('shopsSubmenu');
            const merchModal = document.getElementById('merchantsModal');
            
            if(shopsSub) shopsSub.style.display = 'none';
            if(merchModal) merchModal.style.display = 'none'; 
        });
    }

    if (closeBtn && modal) {
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // cria um elemento para medir o tamanho real de 1rem
  const testEl = document.createElement("div");
  testEl.style.cssText = "position:absolute;visibility:hidden;font-size:1rem;line-height:1;";
  testEl.textContent = "M";
  document.body.appendChild(testEl);

  const actualRem = testEl.getBoundingClientRect().height;
  document.body.removeChild(testEl);

  console.log("[scale-lock] 1rem real:", actualRem, "px");

  // queremos sempre 16px como base (modo padr√£o)
  const targetRem = 16;
  const correction = targetRem / actualRem;

  const style = document.createElement("style");
  style.textContent = `
    html { font-size: ${16 * correction}px !important; }
    body { font-size: 1.3rem !important; }
  `;
  document.head.appendChild(style);

  console.log("[scale-lock] Corre√ß√£o aplicada, fator:", correction.toFixed(2));
});
</script>
<div id="google_translate_element"></div>

<script src="auto_translate.js"></script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<div id="leftSideMenu">
    <div class="menu-header">
        <button id="closeMenuBtn" class="close-menu-btn">
             </button>
        <h3>Menu</h3>
        <div style="width: 28px;"></div> 
    </div>
    <ul id="menuList" class="menu-list">
        </ul>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // --- CONFIGURA√á√ÉO MANUAL ---
    // Mude isso em cada arquivo (ex: "mines.html", "capital.html", "afk.html")
    const MANUAL_CURRENT_PAGE = "mitrar.html"; 

    const assetBase = "https://aden-rpg.pages.dev/assets/";

    const menuItems = [
        { name: "Tela inicial", url: "index.html", icon: assetBase + "homeic.webp" },
        { name: "Aventura AFK", url: "afk.html", icon: assetBase + "expm.webp", key: 'afk' },
        { name: "Minera√ß√£o", url: "mines.html", icon: assetBase + "recursos.webp" }, 
        { name: "Arena PvP", url: "arena.html", icon: assetBase + "pvp.webp", key: 'arena' },
        { name: "Chefe Mundial", url: "solo_boss.html", icon: assetBase + "bossm.webp", key: 'boss' },
        { name: "Guilda", url: "guild.html", icon: assetBase + "guilda.webp", key: 'guild' },
        { name: "Bolsa", url: "inventory.html", icon: assetBase + "iconbolsa.webp" },
        { name: "Ranking", url: "ranking_cp.html", icon: assetBase + "iconranking.webp" },
        { name: "T√≠tulos", url: "titulos.html", icon: assetBase + "icontitulos.webp" },
        { name: "Resgate", url: "resgate.html", icon: assetBase + "resgate.webp" },
        
        // --- NOVO MENU CIDADES (DROPDOWN) ---
        { 
            name: "Cidades", 
            icon: assetBase + "mapicon.webp",
            isDropdown: true, // Flag para indicar que √© dropdown
            subItems: [
                { name: "Capital", url: "capital.html" },
                { name: "Astrax", url: "astrax.html" },
                { name: "Duratar", url: "duratar.html" },
                { name: "Elendor", url: "elendor.html" },
                { name: "Mitrar", url: "mitrar.html" },
                { name: "Tandra", url: "tandra.html" },
                { name: "Zion", url: "zion.html" }
            ]
        }
    ];

    const menuList = document.getElementById("menuList");
    const sideMenu = document.getElementById("leftSideMenu");
    const overlay = document.getElementById("sideMenuOverlay");
    const openBtn = document.getElementById("menuToggleBtn");
    const closeBtn = document.getElementById("closeMenuBtn");

    const hamburgerSVG = `
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    `;
    
    // √çcone de Seta para baixo (Chevron Down)
    const chevronDownSVG = `
        <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    `;

    if(closeBtn) closeBtn.innerHTML = hamburgerSVG;

    if (menuList) {
        menuList.innerHTML = ""; 

        menuItems.forEach(item => {
            const li = document.createElement("li");
            li.className = "menu-item";

            // === CASO 1: √â UM MENU DROPDOWN (CIDADES) ===
            if (item.isDropdown) {
                // Verifica se alguma sub-p√°gina √© a atual (para abrir o menu automaticamente)
                const isSubItemActive = item.subItems.some(sub => sub.url === MANUAL_CURRENT_PAGE);
                
                // Link principal do Dropdown (apenas abre/fecha)
                const a = document.createElement("a");
                a.className = "menu-link dropdown-toggle";
                a.style.cursor = "pointer";
                a.innerHTML = `
                    <img src="${item.icon}" class="menu-icon" alt="√≠cone" onerror="this.style.display='none'">
                    <span>${item.name}</span>
                    ${chevronDownSVG}
                `;

                // Container dos Sub-itens
                const subUl = document.createElement("ul");
                subUl.className = `submenu-list ${isSubItemActive ? 'open' : ''}`; // Abre se estiver dentro

                if(isSubItemActive) li.classList.add('dropdown-active');

                // Toggle ao clicar no pai
                a.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // N√£o fecha o menu lateral
                    subUl.classList.toggle("open");
                    li.classList.toggle("dropdown-active");
                });

                // Renderiza os Sub-itens
                item.subItems.forEach(sub => {
                    const isMatch = (sub.url === MANUAL_CURRENT_PAGE);
                    const subLi = document.createElement("li");
                    subLi.className = `menu-item ${isMatch ? 'active' : ''}`; // Aplica active no li filho

                    const subA = document.createElement("a");
                    subA.className = "menu-link submenu-link"; // Classe extra para padding
                    subA.innerHTML = `<span>${sub.name}</span>`; // Sub-itens sem √≠cone por enquanto

                    if (isMatch) {
                        // Bloqueio Total (igual ao c√≥digo anterior)
                        subA.removeAttribute("href");
                        subA.style.cursor = "default";
                        subA.style.pointerEvents = "none";
                        subA.style.opacity = "1";
                        subA.addEventListener("click", (e) => {
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            return false;
                        }, true);
                    } else {
                        subA.href = sub.url;
                        subA.addEventListener("click", () => {
                            setTimeout(closeMenu, 100);
                        });
                    }

                    subLi.appendChild(subA);
                    subUl.appendChild(subLi);
                });

                li.appendChild(a);
                li.appendChild(subUl);

            } else {
                // === CASO 2: √â UM MENU NORMAL ===
                const isMatch = (item.url === MANUAL_CURRENT_PAGE);
                if(isMatch) li.classList.add('active');

                const a = document.createElement("a");
                a.className = "menu-link";
                a.dataset.menuKey = item.key || '';

                a.innerHTML = `
                    <img src="${item.icon}" class="menu-icon" alt="√≠cone" onerror="this.style.display='none'">
                    <span>${item.name}</span>
                `;

                if (isMatch) {
                    a.removeAttribute("href");
                    a.style.cursor = "default";
                    a.style.pointerEvents = "none";
                    a.style.opacity = "1";
                    a.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    }, true);
                } else {
                    a.href = item.url;
                    a.addEventListener("click", () => {
                         setTimeout(closeMenu, 100);
                    });
                }
                li.appendChild(a);
            }

            menuList.appendChild(li);
        });
    }

    // --- FUN√á√ïES DE CONTROLE DO MENU ---
    const toggleMenuRotation = (isOpening) => {
        if (!openBtn) return;
        const svg = openBtn.querySelector('svg');
        if (svg) {
            if (isOpening) svg.classList.add('icon-vertical');
            else svg.classList.remove('icon-vertical');
        }
    };

    const openMenu = () => {
        if(!sideMenu) return;
        sideMenu.classList.add("open");
        if(overlay) overlay.style.display = "block";
        toggleMenuRotation(true);
        setTimeout(() => {
            if(overlay) {
                overlay.style.opacity = "1";
                overlay.style.pointerEvents = "auto";
            }
        }, 10);
    };

    const closeMenu = () => {
        if(!sideMenu) return;
        sideMenu.classList.remove("open");
        if(overlay) {
            overlay.style.opacity = "0";
            overlay.style.pointerEvents = "none";
        }
        toggleMenuRotation(false);
        setTimeout(() => {
            if(overlay) overlay.style.display = "none";
        }, 300);
    };

    if(openBtn) openBtn.addEventListener("click", openMenu);
    if(closeBtn) closeBtn.addEventListener("click", closeMenu);
    if(overlay) overlay.addEventListener("click", closeMenu);

    // --- RENDERIZAR NOTIFICA√á√ïES (Mantido igual) ---
    const renderSideMenuNotifications = () => {
        const STORAGE_KEY_ACTIONS = 'aden_daily_actions_status';
        let dailyStatus = {};
        try { dailyStatus = JSON.parse(localStorage.getItem(STORAGE_KEY_ACTIONS) || '{}'); } catch(e) {}

        let showGuildDot = false;
        const now = new Date();
        const day = now.getUTCDay(); 
        const hours = now.getUTCHours();
        const minutes = now.getUTCMinutes();
        const KEY_SAT = 'aden_guild_notif_seen_saturday';
        const KEY_SUN = 'aden_guild_notif_seen_sunday';

        if (day === 1) { 
             localStorage.removeItem(KEY_SAT); 
             localStorage.removeItem(KEY_SUN); 
        }
        if (day === 6 && !localStorage.getItem(KEY_SAT)) showGuildDot = true;
        if (day === 0 && (hours === 23 && minutes >= 30) && !localStorage.getItem(KEY_SUN)) showGuildDot = true;

        const links = menuList.querySelectorAll('.menu-link');
        links.forEach(link => {
            const key = link.dataset.menuKey;
            let shouldShow = false;

            if (key && dailyStatus[key] === true) shouldShow = true;
            if (key === 'guild' && showGuildDot) shouldShow = true;

            const existingDot = link.querySelector('.menu-notification-dot');
            if (existingDot) existingDot.remove();

            if (shouldShow) {
                const dot = document.createElement('div');
                dot.className = 'menu-notification-dot';
                link.appendChild(dot);
            }
        });
    };

    renderSideMenuNotifications();
});
</script>
</body>
</html>