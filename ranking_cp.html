<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Ranking de Poder de Combate - Aden RPG</title>
  <style>
    /* ... Estilos base (Intactos) ... */
    body, html { margin:0;padding:0;height:100%;font-family:Arial,Helvetica,sans-serif;display:flex;flex-direction:column;overflow-y:auto;
      background:url('https://aden-rpg.pages.dev/assets/ranking_cp.webp') no-repeat center center fixed;background-size:cover;color:#e0dccc;
      text-shadow: 1px 1px 2px #000;
    }
    #playerTopBar{display:flex;align-items:center;justify-content:space-between;padding:10px 15px;background:linear-gradient(to bottom,#444,#222);color:#fff;min-height:44px;box-shadow:0 2px 5px rgba(0,0,0,0.5);}
    #pageTitle{font-weight:700;font-size:1.1em;text-align:center;flex-grow:1;}
    .top-bar-link{display:flex;align-items:center;color:white;text-decoration:none;}
    
    #rankingContent{
        flex-grow:1;
        padding:20px;
        width: 90vw;
        max-width:999px;
        margin:20px auto;
        border-radius:10px;
        box-shadow:0 0 20px rgba(0,0,0,0.8);
        background-color: rgba(0,0,0,0.5);
        /* Espaço extra para o rodapé fixo não cobrir o último item da lista */
        padding-bottom: 90px;
    }

    #rankingContent h2{color:#c9a94a;margin-top:0;font-size:1.6em;text-align:center;}
    #atualiza {color:#fff;border-bottom:4px solid #c9a94a;margin-top:-20px!important;font-size:1em;text-align:center; margin-bottom: 15px;}

    .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid rgba(201,169,74,0.6);}
    .pulse{animation:pulse 2s infinite;} @keyframes pulse{0%{box-shadow:0 0 0px rgba(255,215,0,1);}70%{box-shadow:2px 2px 56px rgba(255,215,0,0.9);}100%{box-shadow:0 0 0 rgba(255,215,0,0.8);} }
    .loading{text-align:center;padding:20px;font-size:1.05em;opacity:0.9;}
    
    @media(max-width:700px){.avatar{width:40px;height:40px;} }

    /* === ESTILOS DA LISTA E OLHO === */
    #rankingListCP { list-style: none; padding: 0; margin: 0; width: 100%; max-width: 99vw; }
    #rankingListCP li {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px 15px; border-bottom: 1px solid rgba(201,169,74,0.2);
        background: rgba(20, 20, 20, 0.4); transition: background 0.2s ease;
    }
    #rankingListCP li:hover { background: rgba(201, 169, 74, 0.06); }
    
    .rank-position-cp { font-size: 1.1em; font-weight: bold; color: #FFC107; width: 40px; flex-shrink: 0; text-align: center; }
    .rank-avatar-cp { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #888; margin-right: 10px; flex-shrink: 0; }
    .rank-player-info-cp { flex-grow: 1; text-align: left; }
    
    /* Wrapper para nome e olho */
    .rank-player-name-wrapper { display: flex; align-items: center; gap: 8px; }
    
    .rank-player-name-cp {
        display: block; font-size: 1em; font-weight: bold; color: #e0dccc;
        white-space: nowrap; overflow-x: hidden; text-overflow: ellipsis; max-width: 180px;
        cursor: pointer;
    }
    .rank-player-name-cp:hover { color: gold; text-decoration: underline; }
    
    /* Olho Dourado SVG */
    .rank-eye-icon {
        width: 20px; height: 20px; fill: #fff; cursor: pointer; opacity: 0.8; transition: opacity 0.2s, transform 0.2s;
    }
    .rank-eye-icon:hover { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 2px gold); }

    .rank-guild-name-cp { display: block; font-size: 0.85em; color: lightblue; font-weight: bold; }
    .rank-power-cp { font-size: 1.1em; font-weight: bold; color: #4CAF50; text-align: right; min-width: 120px; flex-shrink: 0; }

    /* Top 3 Cores */
    #rankingListCP li:nth-child(1) { background: linear-gradient(180deg, #b79c09, #8b7601, #b79c09); border-left: 5px solid gold; }
    #rankingListCP li:nth-child(1) .rank-position-cp, #rankingListCP li:nth-child(1) .rank-power-cp { color: #FFD700; font-size: 1.2em; text-shadow: 0 0 8px #FFD700, 0 0 15px #000; }
    #rankingListCP li:nth-child(1) .rank-avatar-cp { border: 6px solid #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.7); }

    #rankingListCP li:nth-child(2) { background: linear-gradient(180deg, #a88c8c, #8b6363, #a88c8c); border-left: 5px solid silver; }
    #rankingListCP li:nth-child(2) .rank-position-cp, #rankingListCP li:nth-child(2) .rank-power-cp { color: silver; font-size: 1.15em; text-shadow: 0 0 8px silver; }
    #rankingListCP li:nth-child(2) .rank-avatar-cp { border: 6px solid silver; box-shadow: 0 0 10px rgba(192, 192, 192, 0.7); }

    #rankingListCP li:nth-child(3) { background: linear-gradient(180deg, rgba(173, 99, 26, 0.5), rgba(152, 81, 11, 0.7), rgba(173, 99, 26, 0.5)); border-left: 5px solid #CD7F32; }
    #rankingListCP li:nth-child(3) .rank-position-cp, #rankingListCP li:nth-child(3) .rank-power-cp { color: #CD7F32; font-size: 1.1em; text-shadow: 0 0 8px #CD7F32; }
    #rankingListCP li:nth-child(3) .rank-avatar-cp { border: 6px solid #CD7F32; box-shadow: 0 0 10px rgba(205, 127, 50, 0.7); }
    
    /* === BARRA FIXA DE RANKING DO JOGADOR === */
    #fixedPlayerRank {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 990;
        background: linear-gradient(to top, #141414, #2a2a2a);
        border-top: 3px solid #c9a94a;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.9);
    }
    
    /* Contêiner interno da barra fixa para limitar largura e alinhar */
    #fixedPlayerRank .fixed-content-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        box-sizing: border-box; /* Garante que o padding não estoure a largura */
    }

    /* Cores ajustadas para o footer fixo */
    #fixedPlayerRank .rank-position-cp { color: #fff; font-size: 1.3em; }
    #fixedPlayerRank .rank-player-name-cp { color: #fff; font-size: 1.1em; }
    #fixedPlayerRank .rank-guild-name-cp { color: #ddd; }
    #fixedPlayerRank .rank-power-cp { color: #4CAF50; text-shadow: 0 0 3px black; font-size: 1.2em;}
    #fixedPlayerRank .rank-avatar-cp { border: 2px solid #fff; box-shadow: 0 0 5px gold; }


    /* === MODAL STYLES (INTACTOS PARA MANTER O VISUAL) === */
    #playerModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
    .modal-content-player { background-color: #2c2c2c; padding: 20px; border: 1px solid #c9a94a; width: 90%; max-width: 500px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); color: #e0dccc; position: relative; }
    #closePlayerModal { position: absolute; top: 10px; right: 15px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
    #closePlayerModal:hover { color: white; }
    .player-header { text-align: center; margin-bottom: 15px; }
    #playerName { font-size: 1.8em; color: #FFD700; margin-bottom: 5px; font-weight: bold; }
    .player-level-guild { display: flex; justify-content: center; align-items: center; gap: 2px; margin-bottom: 10px; flex-direction: column; }
    #playerGuildFlag { width: 30px; height: 30px; border-radius: 5px; object-fit: cover; }
    #playerGuildName { font-size: 1.4em; color: lightblue; }
    #playerLevel { font-size: 1.2em; color: #ccc; font-weight: bold; }
    .player-visuals { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    #playerAvatarEquip { width: 85px; height: 85px; border-radius: 50%; border: 4px solid #c9a94a; object-fit: cover; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
    #playerCombatPower { font-size: 2em; font-weight: bold; color: #4CAF50; background: linear-gradient(to bottom, white, orange, orange); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; margin-top: 10px; text-shadow: none!important; }
    .equipment-slots-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 250px; margin: 0 auto; }
    
    /* Configuração Crítica dos Slots para Manter Visual Original */
    .equipment-slot { 
        background-color: #383838; border: 1px dashed #555; height: 55px; width: 55px; 
        display: flex; align-items: center; justify-content: center; position: relative; 
        overflow: visible; /* Importante para o nível sair um pouco pra fora se necessário */
        border-radius: 5px; 
    }
    .equipment-slot img { width: 100%; height: 100%; object-fit: cover; border-radius: 5px; }
    
    /* Estilo do Nível do Item (Restaurado) */
    .item-level {
        position: absolute;
        bottom: -10px;
        right: 7px;
        background-color: rgba(0, 0, 0, 0.7);
        color: #fff;
        font-size: 0.6em;
        padding: 0 3px;
        border-radius: 4px;
        z-index: 99999;
    }

    .player-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; padding: 10px; border-top: 1px solid #444; }
    .stat-line { display: flex; justify-content: space-between; font-size: 0.8em; }
    .stat-line span:first-child { color: #aaa; }
    .stat-line span:last-child { font-weight: bold; color: #fff; }
    .shimmer { background: linear-gradient(-90deg, #383838 0%, #444444 50%, #383838 100%); background-size: 400% 400%; animation: shimmer 1.2s ease-in-out infinite; color: transparent !important; }
    @keyframes shimmer { 0% { background-position: -100% 0; } 100% { background-position: 100% 0; } }
    .shimmer::before { content: '\00a0'; }
    #sendmp { display: none; width: 100%; padding: 10px; margin-top: 20px; background-color: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.2s; text-align: center; text-decoration: none; }
    #sendmp:hover { background-color: #1e84d4; }
    @media(max-width:700px){ .rank-player-name-cp { max-width: 120px; font-size: 0.9em; } .rank-guild-name-cp { font-size: 0.75em; } .rank-power-cp { font-size: 1em; min-width: 90px; } #rankingListCP li { padding: 8px 10px; } }
    #cpIcon { width: 26px; height: 38px; margin-top: 8px; margin-left: -6px; position: relative; }
    
    /* Traductor clean */
    .goog-te-banner-frame.skiptranslate, .skiptranslate, .goog-te-balloon-frame, .goog-te-gadget { display: none !important; visibility: hidden !important; height: 0 !important; }
    body { top: 0px !important; margin-top: 0px !important; position: static !important; }
    font > font { background-color: transparent !important; box-shadow: none !important; position: static !important; }
    /* O Menu em si (ID alterado para não conflitar com o da direita) */
#leftSideMenu {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px; /* Largura um pouco maior para acomodar ícones */
    height: 100%;
    background: #1a1a1a; /* Fundo escuro */
    border-right: 2px solid #444;
    z-index: 9999;
    transform: translateX(-100%); /* Começa escondido à esquerda */
    transition: transform 2s ease;
    display: flex;
    flex-direction: column;
    box-shadow: 5px 0 15px rgba(0,0,0,0.5);
}

/* Classe para abrir o menu via JS */
#leftSideMenu.open {
    transform: translateX(0);
}

/* Cabeçalho do Menu */
.menu-header {
    padding: 15px;
    background: #111;
    display: flex;
    justify-content: space-between; /* Botão e título afastados */
    align-items: center;
    border-bottom: 1px solid #333;
    height: 60px; /* Altura fixa */
    box-sizing: border-box;
}

.menu-header h3 {
    margin: 0;
    color: #ffd700;
    font-size: 1.5rem;
    flex-grow: 1;
    text-align: center; /* Título centralizado */
}

/* Botão de Fechar (Hambúrguer) */
.close-menu-btn {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Lista e Itens */
.menu-list {
    list-style: none;
    padding: 0; /* Remove padding padrão da UL */
    margin: 0;
    display: flex;
    flex-direction: column;
}

.menu-item {
    width: 100%;
}

.menu-link {
    display: flex; /* Flexbox para alinhar ícone e texto */
    align-items: center;
    justify-content: flex-start; /* Alinha tudo à esquerda */
    padding: 15px 15px; /* Padding reduzido na esquerda */
    color: #e0e0e0;
    text-decoration: none;
    font-size: 1.4rem;
    transition: background 0.4s, color 0.4s;
    border-bottom: 1px solid #252525;
    width: 100%;
    box-sizing: border-box;
}

.menu-link:hover {
    background: #333;
    color: #fff;
}

/* Estilo do Ícone no Menu */
.menu-icon {
    width: 35px;
    height: 35px;
    object-fit: contain;
    margin-right: 15px; /* Espaço entre ícone e texto */
}

/* Item Ativo (Página atual) */
.menu-item.active .menu-link {
    background: #555;
    color: #ffd700;
    font-weight: bold;
    border-left: 4px solid #ffd700;
    padding-left: 11px; /* Compensa a borda para manter alinhamento */
}

/* --- ANIMAÇÃO DO BOTÃO DE MENU (TOPO) --- */
#menuToggleBtn svg {
    /* Garante que a transição ocorra suavemente */
    transition: transform 3s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
}

/* Classe para deixar o ícone "Em Pé" (Vertical) */
/* Usamos -90deg para girar à esquerda como pediu */
.icon-vertical {
    transform: rotate(-90deg);
}

/* --- BOTÃO DE FECHAR (DENTRO DO MENU) --- */
/* Força o SVG do botão de fechar a ser idêntico ao botão aberto (Vertical) */
#closeMenuBtn svg {
    transform: rotate(-90deg); 
    transition: transform 3s ease;
    cursor: pointer;
}

/* Opcional: Ao passar o mouse no fechar, ele gira um pouco */
#closeMenuBtn:hover svg {
    transform: rotate(0deg); /* Gira para deitado ao passar o mouse */
    color: #ff4500;
}

/* --- BOLINHAS DE NOTIFICAÇÃO (AJUSTE FINO) --- */
.menu-notification-dot {
    position: absolute;
    /* Ajuste de posição para não ficar em cima do ícone */
    left: 45px; 
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 10px;
    background-color: #ff0000;
    border: 2px solid #fff;
    border-radius: 50%;
    z-index: 15;
    box-shadow: 0 0 5px rgba(255, 0, 0, 0.9);
    pointer-events: none;
    animation: pulseSideDot 2s infinite;
}

@keyframes pulseSideDot {
    0% { transform: translateY(-50%) scale(1); opacity: 1; }
    50% { transform: translateY(-50%) scale(1.3); opacity: 0.8; }
    100% { transform: translateY(-50%) scale(1); opacity: 1; }
}
  </style>
</head>
<body>
  <div id="playerTopBar">
    <button id="menuToggleBtn" class="top-bar-link" style="background:none; border:none; cursor:pointer; color:inherit; padding:0;">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
</button>
    <div id="pageTitle">Ranking de Poder de Combate</div>
    <div style="width:44px;height:34px;"></div>
  </div>

  <div id="rankingContent">
    <h2>Top 10</h2>
   <center> <div id="atualiza">(Atualiza Segunda, Quarta e Sexta-feira às 21h00)</div></center>
    <div id="rankingWrapper"><div id="loading" class="loading">Carregando ranking...</div></div>
  </div>

  <div id="fixedPlayerRank"></div>

  <div id="playerModal">
    <div class="modal-content-player">
      <span id="closePlayerModal">&times;</span>
      
      <div class="player-header">
        <div id="playerName" class="shimmer">Carregando...</div>
         <div style="display: flex; align-items: center; justify-content: center; margin-top: -12px;">
          <div id="playerLevel" class="shimmer">Nv. 1</div>
      </div>
        <div class="player-level-guild">
          <img id="playerGuildFlag" src="https://aden-rpg.pages.dev/assets/guildaflag.webp" alt="Guild Flag" class="shimmer" style="width: 50px; height: 55px;">
          <div id="playerGuildName" class="shimmer">Nome da Guilda</div></div>
          </div>
        <div style="display: none; align-items: center; justify-content: center; gap: 7px; margin-top: -25px; margin-bottom: 8px;">
       <img alt="poder" id="cpIcon" src="https://aden-rpg.pages.dev/assets/CPicon.webp"/> <div id="playerCombatPower" class="shimmer"></div>
      </div>

      <div class="player-visuals">
        <div class="equipment-slots-container left">
            <div class="equipment-slot" id="weapon-slot"></div>
            <div class="equipment-slot" id="ring-slot"></div>
            <div class="equipment-slot" id="helm-slot"></div>
            <div class="equipment-slot" id="special1-slot"></div>
        </div>
        
        <img id="playerAvatarEquip" src="https://via.placeholder.com/120" alt="Player Avatar" class="shimmer">
        
        <div class="equipment-slots-container right">
            <div class="equipment-slot" id="amulet-slot"></div>
            <div class="equipment-slot" id="wing-slot"></div>
            <div class="equipment-slot" id="armor-slot"></div>
            <div class="equipment-slot" id="special2-slot"></div>
        </div>
      </div>

      <div class="player-stats">
        <div class="stat-line"><span>ATK</span><span id="playerAttack" class="shimmer"></span></div>
        <div class="stat-line"><span>Defesa</span><span id="playerDefense" class="shimmer"></span></div>
        <div class="stat-line"><span>HP</span><span id="playerHealth" class="shimmer"></span></div>
        <div class="stat-line"><span>Evasão</span><span id="playerEvasion" class="shimmer"></span></div>
        <div class="stat-line"><span>Taxa Crítica</span><span id="playerCritChance" class="shimmer"></span></div>
        <div class="stat-line"><span>Dano Crítico</span><span id="playerCritDamage" class="shimmer"></span></div>
      </div>
      
      <a id="sendmp" href="#" style="display: none; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1em; padding: 10px;">
          <img src="https://aden-rpg.pages.dev/assets/iconsender.webp" style="width: 35px; height: 35px;"> Enviar Mensagem
      </a>

    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script type="module" src="playerModal.js"></script> 
  <script src="number_format.js"></script>
  <script type="module" src="guild_pv.js"></script>

  <script type="module">
    import { supabase } from './supabaseClient.js'

  (function(){
    // CONFIG DO SUPABASE
    
    function esc(s){ return String(s||''); }
    function safeNum(n){ return typeof n === 'number' ? n : (n?Number(n):0); }

    // =======================================================================
    // NOVO: ADEN GLOBAL DB (INTEGRAÇÃO ZERO EGRESS COMPARTILHADO COM MINAS)
    // =======================================================================
    const GLOBAL_DB_NAME = 'aden_global_db';
    const GLOBAL_DB_VERSION = 6;
    const AUTH_STORE = 'auth_store';
    const OWNERS_STORE = 'owners_store'; // Store compartilhada com mines.js
    
    const GlobalDB = {
        open: function() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(GLOBAL_DB_NAME, GLOBAL_DB_VERSION);
                // NOTA: Se o DB já foi criado pelo mines.js com versão 3, este upgrade não roda.
                // Isso garante compatibilidade.
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(AUTH_STORE)) db.createObjectStore(AUTH_STORE, { keyPath: 'key' });
                    if (!db.objectStoreNames.contains(OWNERS_STORE)) db.createObjectStore(OWNERS_STORE, { keyPath: 'id' });
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        },
        getAuth: async function() {
            try {
                const db = await this.open();
                return new Promise((resolve) => {
                    const tx = db.transaction(AUTH_STORE, 'readonly');
                    const req = tx.objectStore(AUTH_STORE).get('current_session');
                    req.onsuccess = () => resolve(req.result ? req.result.value : null);
                    req.onerror = () => resolve(null);
                });
            } catch(e) { return null; }
        },
        // --- NOVO: Lê todos os donos cacheados (Minas + Bots + Players) ---
        getAllOwners: async function() {
            try {
                const db = await this.open();
                return new Promise((resolve) => {
                    const tx = db.transaction(OWNERS_STORE, 'readonly');
                    const store = tx.objectStore(OWNERS_STORE);
                    const req = store.getAll();
                    req.onsuccess = () => {
                        const result = req.result || [];
                        const map = {};
                        // Mapeia por ID para acesso rápido
                        result.forEach(o => map[o.id] = o);
                        resolve(map);
                    };
                    req.onerror = () => resolve({});
                });
            } catch(e) { return {}; }
        },
        // Salva donos/jogadores no cache compartilhado (útil para mines.js)
        saveOwners: async function(ownersList) {
            if (!ownersList || ownersList.length === 0) return;
            try {
                const db = await this.open();
                const tx = db.transaction(OWNERS_STORE, 'readwrite');
                const store = tx.objectStore(OWNERS_STORE);
                const now = Date.now();

                ownersList.forEach(o => {
                    const cacheObj = {
                        id: o.id,
                        name: o.name,
                        avatar_url: o.avatar_url,
                        guild_id: o.guild_id,
                        timestamp: now // Atualiza timestamp para o TTL de 24h do mines.js
                    };
                    store.put(cacheObj);
                });
                return new Promise(resolve => { tx.oncomplete = () => resolve(); tx.onerror = () => resolve(); });
            } catch(e) { console.warn("Erro ao salvar donos no cache global:", e); }
        }
    };

    // Helper Otimista de Auth (Zero Egress)
    async function getLocalUserId() {
        const globalAuth = await GlobalDB.getAuth();
        if (globalAuth && globalAuth.value && globalAuth.value.user) {
            return globalAuth.value.user.id;
        }
        try {
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith('sb-') && k.endsWith('-auth-token')) {
                    const session = JSON.parse(localStorage.getItem(k));
                    if (session?.user?.id) return session.user.id;
                }
            }
        } catch (e) {}
        return null;
    }

    // ====================================================================================
    // CACHE #1: RANKING DIÁRIO (SEG, QUA, SEX)
    // ====================================================================================
    function calculateNextUpdateDate(){
        const now = new Date();
        for(let i = 1; i <= 7; i++){
            const nextDate = new Date(now);
            nextDate.setUTCDate(now.getUTCDate() + i);
            nextDate.setUTCHours(0,0,0,0);
            const day = nextDate.getUTCDay(); // 0=Dom, 1=Seg ...
            if (day === 1 || day === 3 || day === 5) {
                return nextDate.getTime();
            }
        }
        return now.getTime() + 86400000;
    }

    function setRankingCache(key, value){
        const expirationTime = calculateNextUpdateDate();
        try { localStorage.setItem(key, JSON.stringify({ v:value, e: expirationTime })); } catch(e){}
    }

    function getRankingCache(key){
        try {
            const raw = localStorage.getItem(key);
            if(!raw) return null;
            const obj = JSON.parse(raw);
            if(!obj.e || Date.now()>=obj.e){ localStorage.removeItem(key); return null; }
            return obj.v;
        } catch(e){ return null; }
    }

    // ====================================================================================
    // CACHE #2: PLAYER MODAL
    // ====================================================================================
    function getPlayerCache(playerId) {
        try {
            const key = `player_details_v2_${playerId}`;
            const raw = localStorage.getItem(key);
            if (!raw) return null;
            const obj = JSON.parse(raw);
            if (!obj.e || Date.now() >= obj.e) { localStorage.removeItem(key); return null; }
            return obj.v;
        } catch (e) { return null; }
    }

    function setPlayerCache(playerId, data) {
        try {
            const key = `player_details_v2_${playerId}`;
            const expirationTime = Date.now() + (24 * 60 * 60 * 1000); 
            localStorage.setItem(key, JSON.stringify({ v: data, e: expirationTime }));
        } catch (e) { }
    }

    // ====================================================================================
    // RENDERIZAÇÃO
    // ====================================================================================
    function renderRanking(list, myRankObj){
      const w = document.getElementById('rankingWrapper');
      
      if((!list || list.length === 0)){ w.innerHTML = '<div class="loading">Nenhum jogador encontrado.</div>'; } 
      else {
        let html = '<div id="rankingListContainerCP"><ol id="rankingListCP">';
        
        // Renderiza Top 10 (Limite restaurado)
        for(let i=0;i<list.length && i<10;i++){
            const p = list[i]; 
            const pos = i+1;
            const avatar = esc(p.avatar_url) || 'https://aden-rpg.pages.dev/avatar01.webp';
            
            const eyeIcon = `<svg class="rank-eye-icon" data-player-id="${esc(p.id)}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;

            html += `<li data-player-id="${esc(p.id)}">
            <span class="rank-position-cp">${pos}</span>
            <img class="rank-avatar-cp ${pos===1?'pulse':''}" src="${avatar}" onerror="this.src='https://aden-rpg.pages.dev/avatar01.webp'">
            <div class="rank-player-info-cp">
                <div class="rank-player-name-wrapper">
                    <span class="rank-player-name-cp" data-player-id="${esc(p.id)}">${esc(p.name)}</span>
                    ${eyeIcon}
                </div>
                <span class="rank-guild-name-cp">${esc(p.guild_name||'Sem Guilda')}</span>
            </div>
            <span class="rank-power-cp">${formatNumberCompact(Number(p.cp||0))}</span>
            </li>`;
        }
        html += '</ol></div>';
        w.innerHTML = html;
      }

      // === Renderização da BARRA FIXA ===
      const fixedRankContainer = document.getElementById('fixedPlayerRank');
      if (myRankObj) {
          const p = myRankObj;
          const avatar = esc(p.avatar_url) || 'https://aden-rpg.pages.dev/avatar01.webp';
          const eyeIcon = `<svg class="rank-eye-icon" data-player-id="${esc(p.id)}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
          
          fixedRankContainer.innerHTML = `
          <div class="fixed-content-inner">
             <span class="rank-position-cp">${p.rank}</span>
             <img class="rank-avatar-cp" src="${avatar}" onerror="this.src='https://aden-rpg.pages.dev/avatar01.webp'">
             <div class="rank-player-info-cp">
                 <div class="rank-player-name-wrapper">
                     <span class="rank-player-name-cp" data-player-id="${esc(p.id)}">${esc(p.name)}</span>
                     ${eyeIcon}
                 </div>
                 <span class="rank-guild-name-cp">${esc(p.guild_name||'Sem Guilda')}</span>
             </div>
             <span class="rank-power-cp">${formatNumberCompact(Number(p.cp||0))}</span>
          </div>`;
          fixedRankContainer.style.display = 'block';

          fixedRankContainer.addEventListener('click', (e) => {
              const trigger = e.target.closest('.rank-player-name-cp') || e.target.closest('.rank-eye-icon');
              if (trigger) {
                  const pid = trigger.dataset.playerId;
                  if (pid) {
                      document.getElementById('playerModal').style.display = 'flex';
                      window.fetchPlayerData(pid);
                  }
              }
          });

      } else {
          fixedRankContainer.style.display = 'none';
      }

      document.getElementById('rankingListCP')?.addEventListener('click', (e) => {
          const trigger = e.target.closest('.rank-player-name-cp') || e.target.closest('.rank-eye-icon');
          if (!trigger) return;
          const playerId = trigger.dataset.playerId;
          if (playerId) {
              const playerModal = document.getElementById('playerModal');
              if (playerModal) playerModal.style.display = 'flex';
              window.fetchPlayerData(playerId);
          }
      });
    }

    // ====================================================================================
    // FETCH DETALHES DO JOGADOR
    // ====================================================================================
    window.fetchPlayerDetailsWithCache = async function(playerId) {
        resetModalUI();
        
        const cachedData = getPlayerCache(playerId);
        if (cachedData) {
            populatePlayerModal(cachedData);
            return;
        }

        if (!supabase) return;

        try {
            const { data: player, error: pErr } = await supabase
                .from('players')
                .select('name, level, avatar_url, guild_id, combat_power, cached_combat_stats')
                .eq('id', playerId)
                .single();
            if (pErr) throw pErr;

            let guildInfo = { name: 'Sem Guilda', flag: 'https://aden-rpg.pages.dev/assets/guildaflag.webp' };
            if(player.guild_id){
                const { data: guild } = await supabase.from('guilds').select('name, flag_url').eq('id', player.guild_id).single();
                if(guild){
                    guildInfo.name = guild.name;
                    if(guild.flag_url) guildInfo.flag = guild.flag_url;
                }
            }

            const { data: equippedItems, error: iErr } = await supabase
                .from('inventory_items')
                .select(`
                    equipped_slot,
                    level, 
                    items ( image_url )
                `)
                .eq('player_id', playerId)
                .not('equipped_slot', 'is', null);

            const serverStats = player.cached_combat_stats || {};
            
            const displayStats = {
                attack: safeNum(serverStats.attack),
                defense: safeNum(serverStats.defense),
                health: safeNum(serverStats.health),
                evasion: safeNum(serverStats.evasion),
                crit_chance: safeNum(serverStats.crit_chance),
                crit_damage: safeNum(serverStats.crit_damage)
            };
            
            const fullPlayerData = {
                basic: {
                    name: player.name,
                    level: player.level,
                    avatar_url: player.avatar_url,
                    guild_name: guildInfo.name,
                    guild_flag: guildInfo.flag,
                    cp: player.combat_power || 0
                },
                stats: displayStats,
                items: equippedItems || []
            };

            setPlayerCache(playerId, fullPlayerData);
            populatePlayerModal(fullPlayerData);

        } catch (error) {
            console.error("Erro ao carregar detalhes:", error);
            document.getElementById('playerName').textContent = "Erro ao carregar";
        }
    };

    function populatePlayerModal(data) {
        const { basic, stats, items } = data;

        document.getElementById('playerName').textContent = basic.name;
        document.getElementById('playerName').classList.remove('shimmer');
        document.getElementById('playerLevel').textContent = 'Nv. ' + safeNum(basic.level);
        document.getElementById('playerLevel').classList.remove('shimmer');
        
        const gFlag = document.getElementById('playerGuildFlag');
        gFlag.src = basic.guild_flag;
        gFlag.classList.remove('shimmer');
        const gName = document.getElementById('playerGuildName');
        gName.textContent = basic.guild_name;
        gName.classList.remove('shimmer');

        const cpDiv = document.getElementById('playerCombatPower');
        cpDiv.textContent = formatNumberCompact(basic.cp);
        cpDiv.classList.remove('shimmer');

        const avatarImg = document.getElementById('playerAvatarEquip');
        avatarImg.src = basic.avatar_url || 'https://aden-rpg.pages.dev/avatar01.webp';
        avatarImg.classList.remove('shimmer');

        const statMap = {
            'playerAttack': stats.attack,
            'playerDefense': stats.defense,
            'playerHealth': stats.health,
            'playerEvasion': stats.evasion,
            'playerCritChance': stats.crit_chance + '%',
            'playerCritDamage': stats.crit_damage + '%'
        };
        for (const [id, val] of Object.entries(statMap)) {
            const el = document.getElementById(id);
            if(el) { el.textContent = val; el.classList.remove('shimmer'); }
        }

        document.querySelectorAll('.equipment-slot').forEach(div => div.innerHTML = '');
        
        items.forEach(invItem => {
            if(invItem.equipped_slot && invItem.items && invItem.items.image_url) {
                const slotId = `${invItem.equipped_slot}-slot`;
                const slotDiv = document.getElementById(slotId);
                if(slotDiv) {
                    let itemHtml = `<img src="${invItem.items.image_url}" alt="Item">`;
                    if(invItem.level > 0) {
                        itemHtml += `<div class="item-level">+${invItem.level}</div>`;
                    }
                    slotDiv.innerHTML = itemHtml;
                }
            }
        });

        const sendBtn = document.getElementById('sendmp');
        sendBtn.style.display = 'flex';
        sendBtn.href = "go:msg:" + basic.name; 
    }

    function resetModalUI() {
        const shimmers = ['playerName', 'playerLevel', 'playerGuildName', 'playerCombatPower', 'playerAvatarEquip',
                          'playerAttack', 'playerDefense', 'playerHealth', 'playerEvasion', 'playerCritChance', 'playerCritDamage'];
        shimmers.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('shimmer');
                if(el.tagName !== 'IMG') el.textContent = '';
            }
        });
        document.querySelectorAll('.equipment-slot').forEach(div => div.innerHTML = '');
        document.getElementById('sendmp').style.display = 'none';
    }

    window.fetchPlayerData = window.fetchPlayerDetailsWithCache;

    // ====================================================================================
    // FETCH RANKING PRINCIPAL (COM OTIMIZAÇÃO ZERO EGRESS VIA GLOBALDB)
    // ====================================================================================
    async function fetchTop100ByCombatPower(){
      const myId = await getLocalUserId();

      const viewCacheKey = 'ranking_cp_MWF_v4'; 
      const cachedView = getRankingCache(viewCacheKey);
      
      if(!supabase){ document.getElementById('loading').textContent = 'Supabase erro.'; return; }
      
      let finalRankingList = [];

      try {
        if(cachedView) {
             finalRankingList = cachedView;
        } else {
            document.getElementById('loading').textContent = 'Sincronizando Ranking...';
            
            // 1. Passo Leve: Buscar apenas IDs e CP (O "Esqueleto" do Ranking)
            // Economiza banda pois não baixamos strings longas (avatares/nomes) ainda
            const { data: skeletonList, error: skelErr } = await supabase
              .from('players')
              .select('id, guild_id, combat_power') // SELECT MAGRO
              .neq('is_banned', true)
              .order('combat_power', { ascending: false })
              .limit(10); // Mantive 10 conforme solicitado

            if(skelErr) throw skelErr;
            if(!skeletonList) skeletonList = [];

            // 2. Ler Cache Global (Populado por minas.js e acessos anteriores)
            const globalCacheMap = await GlobalDB.getAllOwners();
            const missingIds = [];
            const idsToUpdateTimestamp = []; // IDs que já temos, mas vamos avisar o DB que estão "ativos"

            // 3. Cruzamento de Dados (Hydration)
            const hydratedList = skeletonList.map(item => {
                const cachedProfile = globalCacheMap[item.id];
                
                if (cachedProfile && cachedProfile.name) {
                    // Temos no cache! Usamos o dado local.
                    idsToUpdateTimestamp.push(cachedProfile);
                    return {
                        ...item,
                        name: cachedProfile.name,
                        avatar_url: cachedProfile.avatar_url,
                        // Guild ID já veio do skeleton, mas mantemos o do cache se quiser consistência
                    };
                } else {
                    // Não temos, marcar para baixar
                    missingIds.push(item.id);
                    return { ...item, _needsFetch: true };
                }
            });

            // 4. Baixar APENAS os dados faltantes (Delta Fetch)
            if (missingIds.length > 0) {
                const { data: freshProfiles } = await supabase
                    .from('players')
                    .select('id, name, avatar_url')
                    .in('id', missingIds);
                
                if (freshProfiles) {
                    // Atualiza a lista hidratada com os dados novos
                    freshProfiles.forEach(fp => {
                        const index = hydratedList.findIndex(h => h.id === fp.id);
                        if (index !== -1) {
                            hydratedList[index].name = fp.name;
                            hydratedList[index].avatar_url = fp.avatar_url;
                            delete hydratedList[index]._needsFetch;
                        }
                    });
                    
                    // Salva os novos no Cache Global
                    // Adiciona guild_id que já tínhamos no skeleton para o cache ficar completo para as minas
                    const toSave = freshProfiles.map(fp => {
                        const original = hydratedList.find(h => h.id === fp.id);
                        return { ...fp, guild_id: original?.guild_id };
                    });
                    await GlobalDB.saveOwners(toSave);
                }
            }

            // 5. Atualizar Timestamps dos que já tínhamos (Refresh Cache TTL)
            // Isso impede que o mines.js apague esses jogadores se eles não visitarem minas por 24h
            if (idsToUpdateTimestamp.length > 0) {
                await GlobalDB.saveOwners(idsToUpdateTimestamp);
            }

            // 6. Resolver Nomes de Guildas (Cachear Guildas separadamente seria ideal no futuro)
            const uniqueGuilds = Array.from(new Set(hydratedList.map(p=>p.guild_id).filter(Boolean)));
            const guildsById = {};
            if(uniqueGuilds.length){
              const { data: guilds } = await supabase.from('guilds').select('id,name').in('id', uniqueGuilds);
              (guilds||[]).forEach(g => guildsById[g.id] = g.name);
            }

            // 7. Formatação Final
            finalRankingList = hydratedList.map(p => ({
                id: p.id,
                name: p.name || 'Desconhecido', 
                avatar_url: p.avatar_url,
                guild_name: p.guild_id ? (guildsById[p.guild_id] || 'Sem Guilda') : 'Sem Guilda',
                guild_id: p.guild_id,
                cp: p.combat_power
            }));

            // Salva no cache de visualização da página (Seg/Qua/Sex)
            setRankingCache(viewCacheKey, finalRankingList);
        }

        // === LÓGICA DO JOGADOR ATUAL PARA BARRA FIXA ===
        let myRankObj = null;

        if (myId) {
            const indexInTop = finalRankingList.findIndex(p => p.id === myId);
            
            if (indexInTop !== -1) {
                myRankObj = { 
                    ...finalRankingList[indexInTop], 
                    rank: indexInTop + 1 
                };
            } else {
                // Tenta pegar do cache global primeiro
                const globalCache = await GlobalDB.getAllOwners();
                let me = globalCache[myId];
                
                // Se não estiver no cache ou faltar CP, busca no server
                if (!me || me.cp === undefined) {
                     const { data: serverMe } = await supabase
                        .from('players')
                        .select('id, name, avatar_url, guild_id, combat_power')
                        .eq('id', myId)
                        .single();
                     me = serverMe;
                     // Salva meus dados atualizados no cache global
                     if(me) await GlobalDB.saveOwners([me]);
                }

                if (me) {
                     const { count } = await supabase
                        .from('players')
                        .select('*', { count: 'exact', head: true })
                        .gt('combat_power', me.combat_power || me.cp);
                    
                     let myGuildName = 'Sem Guilda';
                     if (me.guild_id) {
                         const { data: g } = await supabase.from('guilds').select('name').eq('id', me.guild_id).single();
                         if (g) myGuildName = g.name;
                     }

                     myRankObj = {
                        id: me.id,
                        name: me.name,
                        avatar_url: me.avatar_url,
                        guild_name: myGuildName,
                        cp: me.combat_power || me.cp,
                        rank: (count || 0) + 1
                     };
                }
            }
        }

        renderRanking(finalRankingList, myRankObj);

      } catch(err){
        document.getElementById('rankingWrapper').innerHTML = `<div class="loading">Erro: ${esc(err.message)}</div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', fetchTop100ByCombatPower);
  })();
  </script>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const testEl = document.createElement("div");
      testEl.style.cssText = "position:absolute;visibility:hidden;font-size:1rem;line-height:1;";
      testEl.textContent = "M";
      document.body.appendChild(testEl);
      const actualRem = testEl.getBoundingClientRect().height;
      document.body.removeChild(testEl);
      const targetRem = 16;
      const correction = targetRem / actualRem;
      const style = document.createElement("style");
      style.textContent = `html { font-size: ${16 * correction}px !important; } body { font-size: 1.3rem !important; }`;
      document.head.appendChild(style);
    });
  </script>
  <div id="google_translate_element"></div>
  <script src="auto_translate.js"></script>
  <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  
  <div id="leftSideMenu">
    <div class="menu-header">
        <button id="closeMenuBtn" class="close-menu-btn">
             </button>
        <h3>Menu</h3>
        <div style="width: 28px;"></div> 
    </div>
    <ul id="menuList" class="menu-list">
        </ul>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // --- CONFIGURAÇÃO MANUAL ---
    // Mude isso em cada arquivo (ex: "mines.html", "capital.html", "afk.html")
    const MANUAL_CURRENT_PAGE = "ranking_cp.html"; 

    const assetBase = "https://aden-rpg.pages.dev/assets/";

    const menuItems = [
        { name: "Tela inicial", url: "index.html", icon: assetBase + "homeic.webp" },
        { name: "Aventura AFK", url: "afk.html", icon: assetBase + "expm.webp", key: 'afk' },
        { name: "Mineração", url: "mines.html", icon: assetBase + "recursos.webp" }, 
        { name: "Arena PvP", url: "arena.html", icon: assetBase + "pvp.webp", key: 'arena' },
        { name: "Chefe Mundial", url: "solo_boss.html", icon: assetBase + "bossm.webp", key: 'boss' },
        { name: "Guilda", url: "guild.html", icon: assetBase + "guilda.webp", key: 'guild' },
        { name: "Bolsa", url: "inventory.html", icon: assetBase + "iconbolsa.webp" },
        { name: "Ranking", url: "ranking_cp.html", icon: assetBase + "iconranking.webp" },
        { name: "Títulos", url: "titulos.html", icon: assetBase + "icontitulos.webp" },
        { name: "Resgate", url: "resgate.html", icon: assetBase + "resgate.webp" },
        
        // --- NOVO MENU CIDADES (DROPDOWN) ---
        { 
            name: "Cidades", 
            icon: assetBase + "mapicon.webp",
            isDropdown: true, // Flag para indicar que é dropdown
            subItems: [
                { name: "Capital", url: "capital.html" },
                { name: "Astrax", url: "astrax.html" },
                { name: "Duratar", url: "duratar.html" },
                { name: "Elendor", url: "elendor.html" },
                { name: "Mitrar", url: "mitrar.html" },
                { name: "Tandra", url: "tandra.html" },
                { name: "Zion", url: "zion.html" }
            ]
        }
    ];

    const menuList = document.getElementById("menuList");
    const sideMenu = document.getElementById("leftSideMenu");
    const overlay = document.getElementById("sideMenuOverlay");
    const openBtn = document.getElementById("menuToggleBtn");
    const closeBtn = document.getElementById("closeMenuBtn");

    const hamburgerSVG = `
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    `;
    
    // Ícone de Seta para baixo (Chevron Down)
    const chevronDownSVG = `
        <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    `;

    if(closeBtn) closeBtn.innerHTML = hamburgerSVG;

    if (menuList) {
        menuList.innerHTML = ""; 

        menuItems.forEach(item => {
            const li = document.createElement("li");
            li.className = "menu-item";

            // === CASO 1: É UM MENU DROPDOWN (CIDADES) ===
            if (item.isDropdown) {
                // Verifica se alguma sub-página é a atual (para abrir o menu automaticamente)
                const isSubItemActive = item.subItems.some(sub => sub.url === MANUAL_CURRENT_PAGE);
                
                // Link principal do Dropdown (apenas abre/fecha)
                const a = document.createElement("a");
                a.className = "menu-link dropdown-toggle";
                a.style.cursor = "pointer";
                a.innerHTML = `
                    <img src="${item.icon}" class="menu-icon" alt="ícone" onerror="this.style.display='none'">
                    <span>${item.name}</span>
                    ${chevronDownSVG}
                `;

                // Container dos Sub-itens
                const subUl = document.createElement("ul");
                subUl.className = `submenu-list ${isSubItemActive ? 'open' : ''}`; // Abre se estiver dentro

                if(isSubItemActive) li.classList.add('dropdown-active');

                // Toggle ao clicar no pai
                a.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // Não fecha o menu lateral
                    subUl.classList.toggle("open");
                    li.classList.toggle("dropdown-active");
                });

                // Renderiza os Sub-itens
                item.subItems.forEach(sub => {
                    const isMatch = (sub.url === MANUAL_CURRENT_PAGE);
                    const subLi = document.createElement("li");
                    subLi.className = `menu-item ${isMatch ? 'active' : ''}`; // Aplica active no li filho

                    const subA = document.createElement("a");
                    subA.className = "menu-link submenu-link"; // Classe extra para padding
                    subA.innerHTML = `<span>${sub.name}</span>`; // Sub-itens sem ícone por enquanto

                    if (isMatch) {
                        // Bloqueio Total (igual ao código anterior)
                        subA.removeAttribute("href");
                        subA.style.cursor = "default";
                        subA.style.pointerEvents = "none";
                        subA.style.opacity = "1";
                        subA.addEventListener("click", (e) => {
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            return false;
                        }, true);
                    } else {
                        subA.href = sub.url;
                        subA.addEventListener("click", () => {
                            setTimeout(closeMenu, 100);
                        });
                    }

                    subLi.appendChild(subA);
                    subUl.appendChild(subLi);
                });

                li.appendChild(a);
                li.appendChild(subUl);

            } else {
                // === CASO 2: É UM MENU NORMAL ===
                const isMatch = (item.url === MANUAL_CURRENT_PAGE);
                if(isMatch) li.classList.add('active');

                const a = document.createElement("a");
                a.className = "menu-link";
                a.dataset.menuKey = item.key || '';

                a.innerHTML = `
                    <img src="${item.icon}" class="menu-icon" alt="ícone" onerror="this.style.display='none'">
                    <span>${item.name}</span>
                `;

                if (isMatch) {
                    a.removeAttribute("href");
                    a.style.cursor = "default";
                    a.style.pointerEvents = "none";
                    a.style.opacity = "1";
                    a.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    }, true);
                } else {
                    a.href = item.url;
                    a.addEventListener("click", () => {
                         setTimeout(closeMenu, 100);
                    });
                }
                li.appendChild(a);
            }

            menuList.appendChild(li);
        });
    }

    // --- FUNÇÕES DE CONTROLE DO MENU ---
    const toggleMenuRotation = (isOpening) => {
        if (!openBtn) return;
        const svg = openBtn.querySelector('svg');
        if (svg) {
            if (isOpening) svg.classList.add('icon-vertical');
            else svg.classList.remove('icon-vertical');
        }
    };

    const openMenu = () => {
        if(!sideMenu) return;
        sideMenu.classList.add("open");
        if(overlay) overlay.style.display = "block";
        toggleMenuRotation(true);
        setTimeout(() => {
            if(overlay) {
                overlay.style.opacity = "1";
                overlay.style.pointerEvents = "auto";
            }
        }, 10);
    };

    const closeMenu = () => {
        if(!sideMenu) return;
        sideMenu.classList.remove("open");
        if(overlay) {
            overlay.style.opacity = "0";
            overlay.style.pointerEvents = "none";
        }
        toggleMenuRotation(false);
        setTimeout(() => {
            if(overlay) overlay.style.display = "none";
        }, 300);
    };

    if(openBtn) openBtn.addEventListener("click", openMenu);
    if(closeBtn) closeBtn.addEventListener("click", closeMenu);
    if(overlay) overlay.addEventListener("click", closeMenu);

    // --- RENDERIZAR NOTIFICAÇÕES (Mantido igual) ---
    const renderSideMenuNotifications = () => {
        const STORAGE_KEY_ACTIONS = 'aden_daily_actions_status';
        let dailyStatus = {};
        try { dailyStatus = JSON.parse(localStorage.getItem(STORAGE_KEY_ACTIONS) || '{}'); } catch(e) {}

        let showGuildDot = false;
        const now = new Date();
        const day = now.getUTCDay(); 
        const hours = now.getUTCHours();
        const minutes = now.getUTCMinutes();
        const KEY_SAT = 'aden_guild_notif_seen_saturday';
        const KEY_SUN = 'aden_guild_notif_seen_sunday';

        if (day === 1) { 
             localStorage.removeItem(KEY_SAT); 
             localStorage.removeItem(KEY_SUN); 
        }
        if (day === 6 && !localStorage.getItem(KEY_SAT)) showGuildDot = true;
        if (day === 0 && (hours === 23 && minutes >= 30) && !localStorage.getItem(KEY_SUN)) showGuildDot = true;

        const links = menuList.querySelectorAll('.menu-link');
        links.forEach(link => {
            const key = link.dataset.menuKey;
            let shouldShow = false;

            if (key && dailyStatus[key] === true) shouldShow = true;
            if (key === 'guild' && showGuildDot) shouldShow = true;

            const existingDot = link.querySelector('.menu-notification-dot');
            if (existingDot) existingDot.remove();

            if (shouldShow) {
                const dot = document.createElement('div');
                dot.className = 'menu-notification-dot';
                link.appendChild(dot);
            }
        });
    };

    renderSideMenuNotifications();
});
</script>
<script>
(function() {
    const style = document.createElement('style');

    // Adicionamos as animações e estilos
    style.innerHTML = `
        @keyframes shine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        /* --- ESTILO PARA OS NOBRES (Azul/Brilho) --- */
        .shiny-icon {
            display: inline-block;
            background: linear-gradient(
                120deg, 
                #add8e6 0%, 
                #2b4bf2 40%, 
                #ffffff 50%, 
                #2b4bf2 60%, 
                #add8e6 100%
            );
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            animation: shine 5s linear infinite;
            font-weight: 900;
            font-size: 1.6em;
            line-height: 1;
            vertical-align: middle;
            text-shadow: none !important;
        }

        /* --- ESTILO PARA O JESTER/BOBO (Negativo/Sombrio) --- */
        .jester-icon {
            display: inline-block;
            /* Cores: Preto/Cinza -> Vermelho Escuro -> Roxo -> Vermelho Escuro -> Preto */
            background: linear-gradient(
                120deg, 
                #333333 0%,    /* Cinza Escuro */
                #8b0000 40%,   /* Vermelho Sangue */
                #4b0082 50%,   /* Roxo (Indigo) - o "brilho" maligno */
                #8b0000 60%,   
                #333333 100%
            );
            background-size: 200% auto;
            
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            
            /* Animação um pouco mais rápida e caótica ou igual, mantive igual */
            animation: shine 4s linear infinite; 
            
            font-weight: 900;
            font-size: 1.1em;
            line-height: 1;
            vertical-align: middle;
            
            /* Opcional: Adiciona uma "aura" ruim leve */
            filter: drop-shadow(0 0 1px rgba(139, 0, 0, 0.3));
            text-shadow: none !important;
        }
    `;
    document.head.appendChild(style);

    // Regex segura
    const targetIcons = /(\uD83D\uDC51|\u269C\uFE0F?|\uD83E\uDD21|\uD83D\uDEE1\uFE0F?|\uD83D\uDD30)/g;
    
    // Identificador do Palhaço para comparação
    const jesterEmoji = '\uD83E\uDD21'; // 🤡

    function styleTextNodes(node) {
        if (node.nodeType === 3 && targetIcons.test(node.nodeValue)) {
            const span = document.createElement('span');
            span.innerHTML = node.nodeValue.replace(targetIcons, (match) => {
                // VERIFICAÇÃO: Se for o palhaço, usa a classe jester-icon, senão usa shiny-icon
                const className = (match.indexOf(jesterEmoji) !== -1 || match === '🤡') 
                                  ? 'jester-icon' 
                                  : 'shiny-icon';
                                  
                return `<span class="${className}">${match}</span>`;
            });
            node.parentNode.replaceChild(span, node);
        } else if (node.nodeType === 1 && 
                   node.tagName !== 'SCRIPT' && 
                   node.tagName !== 'STYLE' && 
                   !node.classList.contains('shiny-icon') &&
                   !node.classList.contains('jester-icon')) { // Proteção para não re-estilizar
            Array.from(node.childNodes).forEach(styleTextNodes);
        }
    }

    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                styleTextNodes(node);
            });
        });
    });

    observer.observe(document.body, { childList: true, subtree: true });
    styleTextNodes(document.body);

})();
</script>
</body>
</html>